<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معمل أمان للتحاليل الطبية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            transition: all 0.5s ease;
        }

        /* شاشة الترحيب */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            z-index: 1000;
            transition: opacity 1s ease;
        }

        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .logo {
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
            background-color: white;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .logo img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 15px;
            color: white;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .welcome-subtitle {
            font-size: 20px;
            text-align: center;
            max-width: 80%;
            line-height: 1.6;
            color: white;
        }

        /* مؤشر التحميل */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .loader-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6a11cb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* نموذج تسجيل الدخول والتسجيل */
        .auth-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .auth-form {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(106, 17, 203, 0.1);
        }

        .auth-title {
            color: #6a11cb;
            text-align: center;
            margin-bottom: 25px;
            font-size: 26px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #6a11cb;
            font-weight: 500;
        }

        .form-group input, 
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #6a11cb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }

        .form-group .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .password-toggle {
            position: absolute;
            left: 15px;
            top: 42px;
            cursor: pointer;
            color: #6a11cb;
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(106, 17, 203, 0.4);
        }

        .switch-auth {
            text-align: center;
            margin-top: 20px;
            color: #6a11cb;
        }

        .switch-auth button {
            background: none;
            border: none;
            color: #2575fc;
            cursor: pointer;
            font-weight: 500;
            text-decoration: underline;
            font-size: 15px;
        }

        .forgot-password {
            text-align: left;
            margin-top: -15px;
            margin-bottom: 15px;
        }

        .forgot-password button {
            background: none;
            border: none;
            color: #6a11cb;
            font-size: 14px;
            cursor: pointer;
        }

        /* الصفحة الرئيسية للمستخدم العادي */
        .dashboard {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            flex-direction: column;
            background-color: #f8f9fa;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .home-banner {
            width: 100%;
            height: 350px;
            background-color: #fff;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #333;
            margin-bottom: 30px;
            background-image: url('https://images.unsplash.com/photo-1581595219315-a187dd40c322?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .home-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(106, 17, 203, 0.8) 0%, rgba(37, 117, 252, 0.8) 100%);
            border-radius: 15px;
        }

        .banner-content {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 30px;
            color: white;
        }

        .banner-title {
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .banner-text {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .appointment-button {
            padding: 14px 40px;
            background-color: white;
            color: #6a11cb;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .appointment-button:hover {
            background-color: #f0f0f0;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* زر الاستشارة */
        .consultation-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 999;
            transition: all 0.3s;
        }

        .consultation-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* قسم المواعيد السابقة */
        .appointments-history {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 24px;
            color: #6a11cb;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info h3 {
            color: #6a11cb;
            margin-bottom: 5px;
        }

        .history-info p {
            color: #666;
            font-size: 14px;
        }

        .history-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-new {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status-confirmed {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .status-cancelled {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .cancel-btn {
            background-color: #ffebee;
            color: #d32f2f;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .cancel-btn:hover {
            background-color: #ffcdd2;
        }

        /* نموذج الحجز */
        .appointment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .appointment-form {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(106, 17, 203, 0.1);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .form-header h2 {
            color: #6a11cb;
            font-size: 24px;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6a11cb;
            transition: transform 0.3s;
        }

        .close-button:hover {
            transform: rotate(90deg);
        }

        /* التنبيهات */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
            font-size: 15px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            border-color: #6a11cb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }

        /* تقويم الحجز */
        .calendar {
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-title {
            font-weight: 600;
            color: #6a11cb;
        }

        .calendar-nav {
            display: flex;
        }

        .calendar-nav button {
            background: none;
            border: none;
            cursor: pointer;
            color: #6a11cb;
            font-size: 18px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #6a11cb;
            padding: 5px;
            font-size: 14px;
        }

        .calendar-day {
            text-align: center;
            padding: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-day:hover {
            background-color: #f0f0f0;
        }

        .calendar-day.selected {
            background-color: #6a11cb;
            color: white;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        /* خيارات نوع العينة */
        .sample-types {
            margin-bottom: 20px;
        }

        .sample-types h3 {
            margin-bottom: 10px;
            color: #6a11cb;
            font-size: 16px;
        }

        .sample-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sample-option {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .sample-option.selected {
            background-color: #6a11cb;
            color: white;
        }

        /* لوحة تحكم المدير */
        .admin-dashboard {
            display: none;
            width: 100%;
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .admin-sidebar {
            width: 280px;
            background: linear-gradient(to bottom, #6a11cb, #2575fc);
            color: white;
            padding: 20px 0;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .admin-logo {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-logo h2 {
            font-size: 22px;
            font-weight: 700;
        }

        .admin-menu {
            list-style: none;
            padding: 0;
        }

        .admin-menu li {
            margin-bottom: 5px;
        }

        .admin-menu a {
            display: block;
            padding: 12px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            font-size: 16px;
        }

        .admin-menu a:hover, .admin-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-right: 4px solid white;
        }

        .admin-menu a i {
            margin-left: 10px;
            font-size: 18px;
        }

        .admin-content {
            flex: 1;
            padding: 30px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .admin-header h1 {
            font-size: 28px;
            color: #6a11cb;
        }

        .admin-user {
            display: flex;
            align-items: center;
        }

        .admin-user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .admin-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(106, 17, 203, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .card-header h2 {
            font-size: 22px;
            color: #6a11cb;
        }

        /* الرسوم البيانية */
        .chart-container {
            width: 100%;
            height: 300px;
            margin-bottom: 30px;
        }

        .chart-placeholder {
            width: 100%;
            height: 100%;
            background-color: #f9f9f9;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
        }

        /* البحث والتصفية */
        .search-filter {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            min-width: 150px;
        }

        /* بطاقات المواعيد */
        .appointment-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #6a11cb;
        }

        .appointment-card h3 {
            color: #6a11cb;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .appointment-card p {
            margin-bottom: 8px;
            color: #555;
        }

        .appointment-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 10px;
        }

        .appointment-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-confirm {
            background-color: #28a745;
            color: white;
        }

        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }

        .btn-details {
            background-color: #17a2b8;
            color: white;
        }

        .btn-sms {
            background-color: #6a11cb;
            color: white;
        }

        /* بطاقات الاستشارات */
        .consultation-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #2575fc;
        }

        .consultation-card h3 {
            color: #2575fc;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .consultation-card p {
            margin-bottom: 8px;
            color: #555;
        }

        .consultation-messages {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .consultation-reply {
            margin-top: 15px;
        }

        .consultation-reply textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .consultation-reply button {
            padding: 8px 20px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* نافذة إرسال SMS */
        .sms-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }

        .sms-form {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        /* نموذج الاستشارة */
        .consultation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }

        .consultation-form {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        /* نافذة الدردشة */
        .chat-container {
            display: none;
            position: fixed;
            bottom: 120px;
            left: 30px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            z-index: 998;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
        }

        .message-patient {
            background-color: #e9ecef;
            color: #333;
            margin-right: auto;
            border-bottom-right-radius: 5px;
        }

        .message-doctor {
            background-color: #6a11cb;
            color: white;
            margin-left: auto;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .chat-input button {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
            cursor: pointer;
        }

        /* نتائج التحاليل */
        .test-result {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .test-result h3 {
            color: #6a11cb;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .test-result p {
            margin-bottom: 8px;
            color: #555;
        }

        .test-download {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-size: 14px;
        }

        /* الإحالات الطبية */
        .referral-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #28a745;
        }

        .referral-card h3 {
            color: #28a745;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .referral-card p {
            margin-bottom: 8px;
            color: #555;
        }

        /* أقسام لوحة التحكم المخفية */
        .hidden {
            display: none;
        }

        /* جدول البيانات */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: #f5f5f5;
            color: #6a11cb;
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f9f9f9;
        }

        /* أزرار الإجراءات */
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            transition: all 0.3s;
        }

        .edit-btn {
            background-color: #17a2b8;
            color: white;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .view-btn {
            background-color: #6a11cb;
            color: white;
        }

        /* استجابة للشاشات الصغيرة */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .admin-sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .admin-menu {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .admin-menu li {
                margin: 5px;
            }
            
            .admin-menu a {
                padding: 10px 15px;
                border-radius: 5px;
            }
            
            .admin-menu a:hover, .admin-menu a.active {
                border-right: none;
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }
            
            .user-profile {
                margin-top: 15px;
            }
            
            .home-banner {
                height: auto;
                padding: 40px 20px;
            }
            
            .chat-container {
                width: 90%;
                left: 5%;
                bottom: 100px;
            }
            
            .consultation-button {
                left: 20px;
                bottom: 20px;
                width: 60px;
                height: 60px;
                font-size: 22px;
            }
        }

        @media (max-width: 480px) {
            .auth-form {
                padding: 20px;
            }
            
            .welcome-title {
                font-size: 28px;
            }
            
            .welcome-subtitle {
                font-size: 16px;
            }
            
            .banner-title {
                font-size: 24px;
            }
            
            .banner-text {
                font-size: 16px;
            }
            
            .appointment-button {
                padding: 12px 30px;
            }
            
            .section-title {
                font-size: 20px;
            }
        }

        /* نموذج رفع نتيجة تحليل */
        .upload-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }

        .upload-result-form {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .upload-result-form .form-group {
            margin-bottom: 20px;
        }

        .upload-result-form .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #6a11cb;
            font-weight: 500;
        }

        .upload-result-form .form-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px dashed #6a11cb;
            border-radius: 8px;
            cursor: pointer;
        }

        .upload-result-form .form-group input[type="file"]:hover {
            background-color: #f8f9fa;
        }

        .upload-result-form .upload-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-result-form .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
        }

        /* تعديل أزرار الإجراءات في جدول المواعيد */
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            transition: all 0.3s;
        }

        .upload-btn {
            background-color: #28a745;
            color: white;
        }

        .cancel-btn {
            background-color: #dc3545;
            color: white;
        }

        .view-btn {
            background-color: #17a2b8;
            color: white;
        }

        .status-cancelled {
            background-color: #ffebee;
            color: #dc3545;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- شاشة الترحيب -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="logo">
            <img src="logo.png" alt="شعار معمل أمان">
        </div>
        <h1 class="welcome-title">معمل أمان</h1>
        <p class="welcome-subtitle">عناية متكاملة ودقة عالية في التحاليل الطبية</p>
    </div>
    
    <!-- مؤشر التحميل -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="spinner"></div>
            <p>جاري التحميل...</p>
        </div>
    </div>
    
    <!-- صفحة تسجيل الدخول -->
    <div class="auth-container" id="loginContainer">
        <form class="auth-form" id="loginForm">
            <h2 class="auth-title">تسجيل الدخول</h2>
            
            <div class="alert alert-error" id="loginError"></div>
            
            <div class="form-group">
                <label for="loginPhone">رقم الهاتف أو البريد الإلكتروني</label>
                <input type="text" id="loginPhone" placeholder="أدخل رقم الهاتف أو البريد الإلكتروني" required>
                <div class="error-message" id="loginPhoneError"></div>
            </div>
            
            <div class="form-group">
                <label for="loginPassword">كلمة المرور</label>
                <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور" required>
                <i class="fas fa-eye password-toggle" id="toggleLoginPassword"></i>
                <div class="error-message" id="loginPasswordError"></div>
            </div>
            
            <div class="forgot-password">
                <button type="button" id="forgotPasswordBtn">نسيت كلمة المرور؟</button>
            </div>
            
            <button type="submit" class="auth-button">تسجيل الدخول</button>
            
            <div class="switch-auth">
                <span>ليس لديك حساب؟ </span>
                <button type="button" id="showRegisterBtn">إنشاء حساب جديد</button>
            </div>
        </form>
    </div>
    
    <!-- صفحة التسجيل -->
    <div class="auth-container" id="registerContainer">
        <form class="auth-form" id="registerForm">
            <h2 class="auth-title">إنشاء حساب جديد</h2>
            
            <div class="alert alert-success" id="registerSuccess"></div>
            <div class="alert alert-error" id="registerError"></div>
            
            <div class="form-group">
                <label for="registerName">الاسم الكامل</label>
                <input type="text" id="registerName" placeholder="أدخل الاسم الكامل" required>
                <div class="error-message" id="registerNameError"></div>
            </div>
            
            <div class="form-group">
                <label for="registerPhone">رقم الهاتف</label>
                <input type="tel" id="registerPhone" placeholder="أدخل رقم الهاتف" required>
                <div class="error-message" id="registerPhoneError"></div>
            </div>
            
            <div class="form-group">
                <label for="registerEmail">البريد الإلكتروني (اختياري)</label>
                <input type="email" id="registerEmail" placeholder="أدخل البريد الإلكتروني">
                <div class="error-message" id="registerEmailError"></div>
            </div>
            
            <div class="form-group">
                <label for="registerPassword">كلمة المرور</label>
                <input type="password" id="registerPassword" placeholder="أدخل كلمة المرور" required>
                <i class="fas fa-eye password-toggle" id="toggleRegisterPassword"></i>
                <div class="error-message" id="registerPasswordError"></div>
            </div>
            
            <div class="form-group">
                <label for="registerConfirmPassword">تأكيد كلمة المرور</label>
                <input type="password" id="registerConfirmPassword" placeholder="أعد إدخال كلمة المرور" required>
                <i class="fas fa-eye password-toggle" id="toggleConfirmPassword"></i>
                <div class="error-message" id="registerConfirmPasswordError"></div>
            </div>
            
            <button type="submit" class="auth-button">إنشاء حساب</button>
            
            <div class="switch-auth">
                <span>لديك حساب بالفعل؟ </span>
                <button type="button" id="showLoginBtn">تسجيل الدخول</button>
            </div>
        </form>
    </div>
    
    <!-- لوحة تحكم المستخدم -->
    <div class="dashboard" id="userDashboard">
        <div class="dashboard-header">
            <h1>مرحباً بك في معمل أمان</h1>
            <div class="user-profile">
                <span id="userName">محمد أحمد</span>
                <img src="user-avatar.jpg" alt="صورة المستخدم">
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        
        <div class="home-banner">
            <div class="banner-content">
                <h2 class="banner-title">معمل أمان للتحاليل الطبية</h2>
                <p class="banner-text">نقدم خدمات تحاليل طبية بدقة عالية وتقنيات متطورة لضمان أفضل النتائج لصحتك</p>
                <button class="appointment-button" id="bookAppointmentBtn">حجز موعد جديد</button>
            </div>
        </div>
        
        <div class="appointments-history">
            <h2 class="section-title">مواعيدك القادمة</h2>
            <ul class="history-list" id="upcomingAppointments" style="margin-bottom: 0;">
                <!-- سيتم ملؤها بالبيانات من JavaScript -->
            </ul>
        </div>
        
        <div class="results-section">
            <h2 class="section-title">نتائج التحاليل</h2>
            <div id="resultsList" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- سيتم ملؤها بالبيانات من JavaScript -->
            </div>
        </div>
        
        <div class="referrals-section">
            <h2 class="section-title">الإحالات الطبية</h2>
            <div id="referralsList">
                <!-- سيتم ملؤها بالبيانات من JavaScript -->
            </div>
        </div>
        
        <!-- زر الاستشارة الطبية -->
        <div class="consultation-button" id="consultationBtn">
            <i class="fas fa-comment-medical"></i>
        </div>
    </div>
    
    <!-- لوحة تحكم المدير -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="admin-container">
            <div class="admin-sidebar">
                <div class="admin-logo">
                    <h2>معمل أمان</h2>
                </div>
                
                <ul class="admin-menu">
                    <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                    <li><a href="#" data-section="appointments"><i class="fas fa-calendar-check"></i> المواعيد</a></li>
                    <li><a href="#" data-section="tests"><i class="fas fa-flask"></i> التحاليل</a></li>
                    <li><a href="#" data-section="doctors"><i class="fas fa-user-md"></i> الأطباء</a></li>
                    <li><a href="#" data-section="patients"><i class="fas fa-users"></i> المرضى</a></li>
                    <li><a href="#" data-section="consultations"><i class="fas fa-comment-medical"></i> الاستشارات</a></li>
                    <li><a href="#" data-section="inventory"><i class="fas fa-boxes"></i> المخزون</a></li>
                    <li><a href="#" data-section="reports"><i class="fas fa-chart-line"></i> التقارير</a></li>
                    <li><a href="#" data-section="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
                </ul>
            </div>
            
            <div class="admin-content">
                <div class="admin-header">
                    <h1>لوحة التحكم</h1>
                    <div class="admin-user">
                        <span>مدير النظام</span>
                        <img src="admin-avatar.jpg" alt="صورة المدير">
                        <button class="logout-btn" id="adminLogoutBtn"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
                
                <div class="admin-section" id="dashboardSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>نظرة عامة</h2>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="appointmentsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>المواعيد اليوم</h2>
                            <div class="search-filter">
                                <input type="text" class="search-input" placeholder="بحث..." id="appointmentSearch">
                                <select class="filter-select" id="appointmentFilter">
                                    <option value="all">جميع الحالات</option>
                                    <option value="new">جديد</option>
                                    <option value="confirmed">مؤكد</option>
                                    <option value="cancelled">ملغى</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="todayAppointments">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- قسم المواعيد -->
                <div class="admin-section hidden" id="appointmentsSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إدارة المواعيد</h2>
                            <div class="search-filter">
                                <input type="text" class="search-input" placeholder="بحث باسم المريض أو رقم الهاتف..." id="appointmentsSearch">
                                <select class="filter-select" id="appointmentsFilter">
                                    <option value="all">جميع المواعيد</option>
                                    <option value="today">اليوم</option>
                                    <option value="upcoming">القادمة</option>
                                    <option value="past">الماضية</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الهاتف</th>
                                        <th>اسم المريض</th>
                                        <th>التاريخ</th>
                                        <th>الوقت</th>
                                        <th>نوع التحليل</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentsTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- قسم التحاليل -->
                <div class="admin-section hidden" id="testsSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إدارة التحاليل</h2>
                            <button class="auth-button" id="addTestBtn">إضافة تحليل جديد</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم التحليل</th>
                                        <th>اسم التحليل</th>
                                        <th>السعر (ج.م)</th>
                                        <th>وقت الانتظار</th>
                                        <th>متوفر</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="testsTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- قسم الأطباء -->
                <div class="admin-section hidden" id="doctorsSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إدارة الأطباء</h2>
                            <button class="auth-button" id="addDoctorBtn">إضافة طبيب جديد</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الطبيب</th>
                                        <th>اسم الطبيب</th>
                                        <th>التخصص</th>
                                        <th>رقم الهاتف</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="doctorsTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- قسم المرضى -->
                <div class="admin-section hidden" id="patientsSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إدارة المرضى</h2>
                            <div class="search-filter">
                                <input type="text" class="search-input" placeholder="بحث باسم المريض..." id="patientsSearch">
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم المريض</th>
                                        <th>اسم المريض</th>
                                        <th>رقم الهاتف</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>تاريخ التسجيل</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="patientsTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- قسم الاستشارات -->
                <div class="admin-section hidden" id="consultationsSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إدارة الاستشارات</h2>
                            <div class="search-filter">
                                <input type="text" class="search-input" placeholder="بحث باسم المريض..." id="consultationsSearch">
                                <select class="filter-select" id="consultationsFilter">
                                    <option value="all">جميع الاستشارات</option>
                                    <option value="pending">قيد الانتظار</option>
                                    <option value="answered">تم الرد</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="consultationsList">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- قسم المخزون -->
                <div class="admin-section hidden" id="inventorySection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إدارة المخزون</h2>
                            <button class="auth-button" id="addInventoryBtn">إضافة مادة جديدة</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم المادة</th>
                                        <th>اسم المادة</th>
                                        <th>الكمية المتاحة</th>
                                        <th>حد الطلب</th>
                                        <th>تاريخ الصلاحية</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- نموذج إضافة/تعديل مادة -->
                    <div class="appointment-modal" id="addInventoryModal">
                        <div class="appointment-form">
                            <div class="form-header">
                                <h2 id="inventoryModalTitle">إضافة مادة جديدة</h2>
                                <button class="close-button" onclick="document.getElementById('addInventoryModal').style.display='none'">&times;</button>
                            </div>
                            
                            <div class="form-group">
                                <label>اسم المادة</label>
                                <input type="text" id="itemName" required>
                            </div>
                            
                            <div class="form-group">
                                <label>الكمية</label>
                                <input type="number" id="itemQuantity" min="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label>السعر (ج.م)</label>
                                <input type="number" id="itemPrice" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label>تاريخ الصلاحية</label>
                                <input type="date" id="itemExpiry" required>
                            </div>
                            
                            <button type="button" class="auth-button" id="saveInventoryBtn">حفظ</button>
                        </div>
                    </div>
                    
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>المواد المنتهية الصلاحية</h2>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم المادة</th>
                                        <th>اسم المادة</th>
                                        <th>الكمية</th>
                                        <th>تاريخ الانتهاء</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="expiredInventoryTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- قسم التقارير -->
                <div class="admin-section hidden" id="reportsSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>التقارير والإحصائيات</h2>
                            <div class="search-filter">
                                <select class="filter-select" id="reportType">
                                    <option value="monthly">تقرير شهري</option>
                                    <option value="daily">تقرير يومي</option>
                                    <option value="tests">تقرير التحاليل</option>
                                </select>
                                <input type="month" id="reportMonth" class="filter-select">
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="reportsChart"></canvas>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>عدد الطلبات</th>
                                        <th>إجمالي الإيرادات (ج.م)</th>
                                        <th>التحاليل الأكثر طلباً</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- قسم الإعدادات -->
                <div class="admin-section hidden" id="settingsSection">
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إعدادات النظام</h2>
                        </div>
                        
                        <form id="systemSettingsForm">
                            <div class="form-group">
                                <label for="labName">اسم المعمل</label>
                                <input type="text" id="labName" placeholder="اسم المعمل" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="labAddress">عنوان المعمل</label>
                                <input type="text" id="labAddress" placeholder="عنوان المعمل" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="labPhone">هاتف المعمل</label>
                                <input type="tel" id="labPhone" placeholder="هاتف المعمل" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="labEmail">البريد الإلكتروني</label>
                                <input type="email" id="labEmail" placeholder="البريد الإلكتروني" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="workingHours">ساعات العمل</label>
                                <input type="text" id="workingHours" placeholder="ساعات العمل" required>
                            </div>
                            
                            <button type="submit" class="auth-button">حفظ الإعدادات</button>
                        </form>
                    </div>
                    
                    <div class="admin-card">
                        <div class="card-header">
                            <h2>إعدادات الحساب</h2>
                        </div>
                        
                        <form id="accountSettingsForm">
                            <div class="form-group">
                                <label for="adminName">اسم المستخدم</label>
                                <input type="text" id="adminName" placeholder="اسم المستخدم" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="adminEmail">البريد الإلكتروني</label>
                                <input type="email" id="adminEmail" placeholder="البريد الإلكتروني" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="adminPhone">رقم الهاتف</label>
                                <input type="tel" id="adminPhone" placeholder="رقم الهاتف" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="currentPassword">كلمة المرور الحالية</label>
                                <input type="password" id="currentPassword" placeholder="كلمة المرور الحالية">
                            </div>
                            
                            <div class="form-group">
                                <label for="newPassword">كلمة المرور الجديدة</label>
                                <input type="password" id="newPassword" placeholder="كلمة المرور الجديدة">
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmNewPassword">تأكيد كلمة المرور الجديدة</label>
                                <input type="password" id="confirmNewPassword" placeholder="تأكيد كلمة المرور الجديدة">
                            </div>
                            
                            <button type="submit" class="auth-button">حفظ التغييرات</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نموذج حجز موعد -->
    <div class="appointment-modal" id="appointmentModal">
        <!-- محتوى النموذج -->
    </div>
    
    <!-- نموذج الاستشارة الطبية -->
    <div class="consultation-modal" id="consultationModal">
        <!-- محتوى النموذج -->
    </div>
    
    <!-- نافذة الدردشة -->
    <div class="chat-container" id="chatContainer">
        <!-- محتوى الدردشة -->
    </div>
    
    <!-- نافذة إرسال SMS -->
    <div class="sms-modal" id="smsModal">
        <!-- محتوى النموذج -->
    </div>
    
    <!-- نموذج إضافة تحليل -->
    <div class="appointment-modal" id="addTestModal">
        <!-- محتوى النموذج -->
    </div>
    
    <!-- نموذج إضافة طبيب -->
    <div class="appointment-modal" id="addDoctorModal">
        <!-- محتوى النموذج -->
    </div>
    
    <!-- نموذج إضافة مادة للمخزون -->
    <div class="appointment-modal" id="addInventoryModal">
        <!-- محتوى النموذج -->
    </div>
    
    <!-- نموذج رفع نتيجة تحليل -->
    <div class="upload-result-modal" id="uploadResultModal">
        <div class="upload-result-form">
            <div class="form-header">
                <h2>رفع نتيجة تحليل</h2>
                <button class="close-button" id="closeUploadResultModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="testResultFile">ملف النتيجة</label>
                <input type="file" id="testResultFile">
            </div>
            
            <button type="button" class="upload-btn" id="uploadResultBtn">رفع النتيجة</button>
        </div>
    </div>
    
    <!-- نموذج عرض المريض -->
    <div class="appointment-modal" id="viewPatientModal">
        <!-- محتوى النموذج -->
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // متغيرات عامة
        // جعل apiBase ديناميكي حسب البيئة
        const apiBase = 
          window.location.hostname === 'localhost' || 
          window.location.hostname === '127.0.0.1' ||
          window.location.hostname === ''
            ? 'http://localhost:3000/api'
            : 'https://aman-lab-backend.onrender.com/api'; // سيتم تغييره لرابط الـ backend السحابي
        
        console.log('API Base:', apiBase); // للتأكد من الرابط المستخدم
        
        let currentUser = null;
        let isAdmin = false;
        let consultations = [];
        let appointments = [];
        let tests = [];
        let doctors = [];
        let inventory = [];
        let expiredInventory = [];
        let systemSettings = {};
        let activeConsultation = null;
        let chatSocket = null;
        let authToken = localStorage.getItem('authToken');
        
        // إعداد headers للـ API calls
        const getHeaders = () => ({
            'Content-Type': 'application/json',
            ...(authToken && { 'Authorization': `Bearer ${authToken}` })
        });

        // دالة مساعدة لفحص الاتصال بالخادم
        async function checkServerConnection() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(apiBase + '/health', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                console.error('Server connection check failed:', error);
                if (error.name === 'AbortError') {
                    console.error('Request timed out');
                }
                return false;
            }
        }

        // دالة مساعدة لعرض رسائل الخطأ
        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                errorElement.style.backgroundColor = '#f8d7da';
                errorElement.style.color = '#721c24';
                errorElement.style.border = '1px solid #f5c6cb';
                errorElement.style.padding = '10px 15px';
                errorElement.style.borderRadius = '5px';
                errorElement.style.marginBottom = '15px';
                errorElement.style.fontSize = '14px';
            }
        }

        // دالة مساعدة لإخفاء رسائل الخطأ
        function hideLoginError() {
            const errorElement = document.getElementById('loginError');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        // عناصر DOM
        const welcomeScreen = document.getElementById('welcomeScreen');
        const loader = document.getElementById('loader');
        const loginContainer = document.getElementById('loginContainer');
        const registerContainer = document.getElementById('registerContainer');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const bookAppointmentBtn = document.getElementById('bookAppointmentBtn');
        const consultationBtn = document.getElementById('consultationBtn');
        const appointmentModal = document.getElementById('appointmentModal');
        const consultationModal = document.getElementById('consultationModal');
        const chatContainer = document.getElementById('chatContainer');
        const smsModal = document.getElementById('smsModal');
        const addTestBtn = document.getElementById('addTestBtn');
        const addDoctorBtn = document.getElementById('addDoctorBtn');
        const addInventoryBtn = document.getElementById('addInventoryBtn');

        // عرض شاشة الترحيب أولاً
        document.addEventListener('DOMContentLoaded', async () => {
            setTimeout(async () => {
                welcomeScreen.classList.add('hidden');
                loader.style.display = 'flex';
                
                // فحص حالة الخادم
                try {
                    const isServerConnected = await checkServerConnection();
                    if (!isServerConnected) {
                        console.warn('Server is not accessible');
                    } else {
                        console.log('Server is accessible');
                    }
                } catch (error) {
                    console.warn('Could not check server status:', error);
                }
                
                // تحميل التطبيق
                setTimeout(initApp, 1500);
            }, 2000);
        });

        // تهيئة التطبيق
        async function initApp() {
            loader.style.display = 'none';
            
            // التحقق من وجود token
            if (authToken) {
                try {
                    // التحقق من صحة الـ token
                    const response = await fetch(apiBase + '/profile', {
                        headers: getHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.user) {
                            currentUser = data.user;
                            isAdmin = currentUser.role === 'admin';
                            if (isAdmin) {
                                showAdminDashboard(currentUser);
            } else {
                                showUserDashboard(currentUser);
                            }
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Token validation error:', error);
                }
                
                // إذا وصل هنا، فالتوكن غير صالح
                localStorage.removeItem('authToken');
                authToken = null;
            }
            
            // عرض صفحة تسجيل الدخول
            showLogin();
            setupEventListeners();
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // أحداث تسجيل الدخول والتسجيل
            showRegisterBtn.addEventListener('click', showRegister);
            showLoginBtn.addEventListener('click', showLogin);
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            adminLogoutBtn.addEventListener('click', handleLogout);
            
            // أحداث إظهار/إخفاء كلمة المرور
            document.getElementById('toggleLoginPassword').addEventListener('click', togglePasswordVisibility.bind(null, 'loginPassword'));
            document.getElementById('toggleRegisterPassword').addEventListener('click', togglePasswordVisibility.bind(null, 'registerPassword'));
            document.getElementById('toggleConfirmPassword').addEventListener('click', togglePasswordVisibility.bind(null, 'registerConfirmPassword'));
            
            // أحداث لوحة المستخدم
            bookAppointmentBtn.addEventListener('click', showAppointmentModal);
            consultationBtn.addEventListener('click', showConsultationModal);
            
            // أحداث لوحة المدير
            document.querySelectorAll('.admin-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    showAdminSection(section);
                });
            });
            
            // أحداث الأزرار في لوحة المدير
            if (addTestBtn) addTestBtn.addEventListener('click', showAddTestModal);
            if (addDoctorBtn) addDoctorBtn.addEventListener('click', showAddDoctorModal);
            if (addInventoryBtn) addInventoryBtn.addEventListener('click', showAddInventoryModal);
            
            // أحداث البحث في المواعيد
            const appointmentsSearch = document.getElementById('appointmentsSearch');
            const appointmentsFilter = document.getElementById('appointmentsFilter');
            
            if (appointmentsSearch) {
                appointmentsSearch.addEventListener('input', () => {
                    if (document.getElementById('appointmentsSection') && !document.getElementById('appointmentsSection').classList.contains('hidden')) {
                        loadAppointments();
                    }
                });
            }
            
            if (appointmentsFilter) {
                appointmentsFilter.addEventListener('change', () => {
                    if (document.getElementById('appointmentsSection') && !document.getElementById('appointmentsSection').classList.contains('hidden')) {
                        loadAppointments();
                    }
                });
            }
        }

        // إظهار/إخفاء كلمة المرور
        function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const toggleIcon = document.getElementById(`toggle${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}`);
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // عرض صفحة تسجيل الدخول
        function showLogin() {
            loginContainer.style.display = 'flex';
            registerContainer.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            
            // مسح حقول النموذج
            loginForm.reset();
            hideLoginError();
            
            // إضافة رسالة ترحيب إذا كان الخادم متاح
            checkServerConnection().then(isConnected => {
                if (!isConnected) {
                    showLoginError('تحذير: لا يمكن الاتصال بالخادم. تأكد من تشغيل السيرفر.');
                }
            });
        }

        // عرض صفحة التسجيل
        function showRegister() {
            loginContainer.style.display = 'none';
            registerContainer.style.display = 'flex';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            
            // مسح حقول النموذج
            registerForm.reset();
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('registerSuccess').style.display = 'none';
            
            // إضافة رسالة تحذير إذا كان الخادم غير متاح
            checkServerConnection().then(isConnected => {
                if (!isConnected) {
                    showAlert('warning', 'تحذير: لا يمكن الاتصال بالخادم. تأكد من تشغيل السيرفر.');
                }
            });
        }

        // عرض لوحة المستخدم
        function showUserDashboard(user) {
            currentUser = user;
            isAdmin = false;
            
            loginContainer.style.display = 'none';
            registerContainer.style.display = 'none';
            userDashboard.style.display = 'flex';
            adminDashboard.style.display = 'none';
            
            // تعبئة بيانات المستخدم
            document.getElementById('userName').textContent = user.name;
            
            // تحديث قائمة المرضى إذا لم يكن المستخدم موجوداً
            const existingPatient = users.find(p => p.id === user.id);
            if (!existingPatient) {
                users.push(user);
                localStorage.setItem('users', JSON.stringify(users));
                saveData();
            }
            
            // تحميل بيانات المستخدم
            loadUserData(user);
            setupEventListeners(); // إعادة ربط الأحداث بعد كل عرض للوحة المستخدم
        }

        // عرض لوحة المدير
        function showAdminDashboard(admin) {
            currentUser = admin;
            isAdmin = true;
            
            loginContainer.style.display = 'none';
            registerContainer.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'block';
            
            // تحميل بيانات المدير
            loadAdminData();
            
            // عرض قسم لوحة التحكم افتراضياً
            showAdminSection('dashboard');
            setupEventListeners(); // إعادة ربط الأحداث بعد كل عرض للوحة المدير
        }

        // عرض قسم معين في لوحة المدير
        function showAdminSection(sectionId) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // إزالة النشط من جميع عناصر القائمة
            document.querySelectorAll('.admin-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            // عرض القسم المطلوب
            document.getElementById(`${sectionId}Section`).classList.remove('hidden');
            
            // إضافة النشط لعنصر القائمة
            document.querySelector(`.admin-menu a[data-section="${sectionId}"]`).classList.add('active');
            
            // تحميل بيانات القسم إذا لزم الأمر
            switch(sectionId) {
                case 'appointments':
                    loadAppointments();
                    // إعادة إضافة أحداث البحث بعد تحميل القسم
                    setTimeout(() => {
                        const appointmentsSearch = document.getElementById('appointmentsSearch');
                        const appointmentsFilter = document.getElementById('appointmentsFilter');
                        
                        if (appointmentsSearch) {
                            appointmentsSearch.addEventListener('input', loadAppointments);
                        }
                        
                        if (appointmentsFilter) {
                            appointmentsFilter.addEventListener('change', loadAppointments);
                        }
                    }, 100);
                    break;
                case 'tests':
                    loadTests();
                    break;
                case 'doctors':
                    loadDoctors();
                    break;
                case 'patients':
                    loadPatients();
                    break;
                case 'consultations':
                    loadConsultations();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // معالجة تسجيل الدخول
        async function handleLogin(e) {
            e.preventDefault();
            
            // إخفاء أي رسائل خطأ سابقة
            hideLoginError();
            
            // مسح أي رسائل خطأ سابقة في النموذج
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.style.display = 'none';
            });
            
            const phoneEmail = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // التحقق من إدخال البيانات
            if (!phoneEmail || !password) {
                showLoginError('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // التحقق من صحة البريد الإلكتروني إذا تم إدخاله
            if (phoneEmail.includes('@') && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(phoneEmail)) {
                showLoginError('البريد الإلكتروني غير صالح');
                return;
            }
            
            // إظهار مؤشر التحميل
            loader.style.display = 'flex';
            
            try {
                // فحص الاتصال بالخادم أولاً
                const isServerConnected = await checkServerConnection();
                if (!isServerConnected) {
                    throw new Error('لا يمكن الاتصال بالخادم');
                }
                
                console.log('Attempting login with:', { phoneEmail, password: '***' });
                
                const response = await fetch(apiBase + '/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ phoneOrEmail: phoneEmail, password })
                });
                
                console.log('Login response status:', response.status);
                
                // التحقق من حالة الاستجابة
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `خطأ في الخادم: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Login response data:', data);
                
                if (data.token && data.user) {
                    // نجح تسجيل الدخول
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    isAdmin = data.isAdmin || data.user.role === 'admin';
                    
                    console.log('Login successful:', { user: data.user, isAdmin });
                    
                    if (isAdmin) {
                        showAdminDashboard(currentUser);
                    } else {
                        showUserDashboard(currentUser);
                    }
                } else {
                    throw new Error(data.message || 'بيانات الدخول غير صحيحة');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
                
                if (error.message.includes('لا يمكن الاتصال بالخادم')) {
                    errorMessage = 'لا يمكن الاتصال بالخادم. تأكد من تشغيل السيرفر.';
                } else if (error.message.includes('بيانات الدخول غير صحيحة')) {
                    errorMessage = 'رقم الهاتف/البريد الإلكتروني أو كلمة المرور غير صحيحة';
                } else if (error.message.includes('خطأ في الخادم')) {
                    errorMessage = 'خطأ في الخادم. حاول مرة أخرى لاحقاً.';
                } else {
                    errorMessage = error.message || 'حدث خطأ غير متوقع';
                }
                
                showLoginError(errorMessage);
            } finally {
                // إخفاء مؤشر التحميل
                loader.style.display = 'none';
            }
        }

        // معالجة التسجيل
        async function handleRegister(e) {
            e.preventDefault();
            const registerError = document.getElementById('registerError');
            const registerSuccess = document.getElementById('registerSuccess');
            if (registerError) registerError.style.display = 'none';
            if (registerSuccess) registerSuccess.style.display = 'none';
            const name = document.getElementById('registerName').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
            if (!name || !phone || !password) {
                showAlert('error', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            if (password !== confirmPassword) {
                showAlert('error', 'كلمة المرور غير متطابقة');
                return;
            }
            if (password.length < 6) {
                showAlert('error', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return;
            }
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showAlert('error', 'البريد الإلكتروني غير صالح');
                return;
            }
            if (!/^[0-9]{10,15}$/.test(phone)) {
                showAlert('error', 'رقم الهاتف غير صالح');
                return;
            }
            loader.style.display = 'flex';
            try {
                // تحقق أولاً من وجود رقم الهاتف
                const checkRes = await fetch(apiBase + '/users/check-phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });
                const checkData = await checkRes.json();
                if (checkRes.ok && checkData.exists) {
                    loader.style.display = 'none';
                    showAlert('error', 'رقم الهاتف مستخدم بالفعل');
                    return;
                }
                // إذا لم يكن موجودًا، أكمل التسجيل
                const response = await fetch(apiBase + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ name, phone, email, password })
                });
                const data = await response.json().catch(() => ({}));
                loader.style.display = 'none';
                if (response.ok && data.message) {
                    showAlert('success', 'تم إنشاء الحساب بنجاح! يمكنك تسجيل الدخول الآن.');
                    registerForm.reset();
                    setTimeout(showLogin, 2000);
                } else {
                    throw new Error(data.message || 'حدث خطأ أثناء التسجيل');
                }
            } catch (error) {
                loader.style.display = 'none';
                let errorMessage = 'حدث خطأ أثناء التسجيل';
                if (error.message.includes('مستخدم بالفعل')) {
                    errorMessage = 'رقم الهاتف مستخدم بالفعل';
                } else {
                    errorMessage = error.message || 'حدث خطأ غير متوقع';
                }
                showAlert('error', errorMessage);
            }
        }

        // معالجة تسجيل الخروج
        function handleLogout() {
            if (chatSocket) {
                chatSocket.close();
                chatSocket = null;
            }
            
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            isAdmin = false;
            
            showLogin();
        }

        // تحميل بيانات المستخدم
        function loadUserData(user) {
            loader.style.display = 'flex';
            fetch(apiBase + '/appointments', {
                headers: getHeaders()
            })
            .then(async res => {
                if (!res.ok) throw new Error('فشل تحميل المواعيد');
                return res.json();
            })
            .then(appointmentsData => {
                // ترتيب المواعيد من الأقرب للأبعد
                const upcoming = appointmentsData.filter(app => new Date(app.date) > new Date() && app.status !== 'ملغى');
                upcoming.sort((a, b) => new Date(a.date) - new Date(b.date));
                const appointmentsList = document.getElementById('upcomingAppointments');
                appointmentsList.innerHTML = '';
                if (upcoming.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = '<p>لا يوجد مواعيد قادمة</p>';
                    appointmentsList.appendChild(li);
                } else {
                    upcoming.forEach(appointment => {
                        const li = document.createElement('li');
                        li.className = 'history-item';
                        li.innerHTML = `
                            <div class="history-info">
                                <h3>${appointment.type}</h3>
                                <p>${new Date(appointment.date).toLocaleDateString('ar-EG')} - ${appointment.time}</p>
                                ${appointment.notes ? `<p style="font-size: 12px; color: #666; margin-top: 5px;"><i class="fas fa-sticky-note"></i> ${appointment.notes}</p>` : ''}
                            </div>
                            <span class="history-status ${appointment.status === 'مؤكد' ? 'status-confirmed' : appointment.status === 'جديد' ? 'status-new' : 'status-cancelled'}">
                                ${appointment.status}
                            </span>
                        `;
                        appointmentsList.appendChild(li);
                    });
                }
                // جلب نتائج التحاليل
                return fetch(apiBase + '/test-results', {
                    headers: getHeaders()
                });
            })
            .then(async res => {
                if (!res.ok) throw new Error('فشل تحميل نتائج التحاليل');
                return res.json();
            })
            .then(testResults => {
                const resultsList = document.getElementById('resultsList');
                resultsList.innerHTML = '';
                if (testResults.length === 0) {
                    resultsList.innerHTML = '<p>لا توجد نتائج تحاليل متاحة</p>';
                } else {
                    testResults.forEach(result => {
                        const div = document.createElement('div');
                        div.className = 'test-result';
                        div.style.border = '2px solid #6a11cb';
                        div.style.borderRadius = '12px';
                        div.style.padding = '18px 20px';
                        div.style.background = '#fff';
                        div.style.boxShadow = '0 2px 8px rgba(106,17,203,0.07)';
                        div.style.marginBottom = '0';
                        div.innerHTML = `
                            <h3 style="color:#6a11cb; margin-bottom:10px; font-size:20px;">${result.type}</h3>
                            <p style="margin-bottom:8px; color:#444;">التاريخ: <b>${new Date(result.resultDate).toLocaleDateString('ar-EG')}</b></p>
                            <button onclick="window.open('${result.fileUrl}','_blank')" style="padding:10px 22px; background:linear-gradient(to right,#6a11cb,#2575fc); color:#fff; border:none; border-radius:6px; font-size:15px; font-weight:500; cursor:pointer; margin-top:8px;">
                                <i class='fas fa-download'></i> تحميل النتيجة
                            </button>
                        `;
                        resultsList.appendChild(div);
                    });
                }
                loader.style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading user data:', error);
                loader.style.display = 'none';
                showAlert('error', error.message || 'حدث خطأ أثناء تحميل البيانات');
            });
        }

        // تحميل بيانات لوحة المدير
        function loadAdminData() {
            loader.style.display = 'flex';
            fetch(apiBase + '/appointments/stats', {
                headers: getHeaders()
            })
            .then(async res => {
                if (!res.ok) throw new Error('فشل تحميل إحصائيات المواعيد');
                return res.json();
            })
            .then(stats => {
                // إنشاء مخطط المواعيد
                createAppointmentsChart(stats);
                
                // جلب مواعيد اليوم
                const today = new Date().toISOString().split('T')[0];
                return fetch(apiBase + `/appointments?date=${today}`, {
                    headers: getHeaders()
                });
            })
            .then(async res => {
                if (!res.ok) throw new Error('فشل تحميل مواعيد اليوم');
                return res.json();
            })
            .then(todayAppointments => {
                // ترتيب المواعيد اليوم حسب الوقت
                todayAppointments.sort((a, b) => a.time.localeCompare(b.time));
                
                // عرض المواعيد اليوم
                const appointmentsContainer = document.getElementById('todayAppointments');
                appointmentsContainer.innerHTML = '';
                
                if (todayAppointments.length === 0) {
                    appointmentsContainer.innerHTML = '<p>لا يوجد مواعيد اليوم</p>';
                } else {
                    todayAppointments.forEach(appointment => {
                        const patient = appointment.patientId;
                        const div = document.createElement('div');
                        div.className = 'appointment-card';
                        div.innerHTML = `
                            <h3>${patient?.name || 'مريض غير معروف'}</h3>
                            <p><strong>رقم الهاتف:</strong> ${patient?.phone || 'غير محدد'}</p>
                            <p><strong>الوقت:</strong> ${appointment.time}</p>
                            <p><strong>نوع التحليل:</strong> ${appointment.type}</p>
                            <p><strong>الحالة:</strong> 
                                <span class="${appointment.status === 'مؤكد' ? 'status-confirmed' : 
                                             appointment.status === 'جديد' ? 'status-new' : 'status-cancelled'}">
                                    ${appointment.status}
                                </span>
                            </p>
                            ${appointment.notes ? `<p><strong>ملاحظات:</strong> ${appointment.notes}</p>` : ''}
                            <div class="appointment-actions">
                                <button class="btn-confirm" data-id="${appointment._id}">تأكيد</button>
                                <button class="btn-cancel" data-id="${appointment._id}">إلغاء</button>
                                <button class="btn-details" data-id="${appointment._id}">تفاصيل</button>
                                <button class="btn-sms" data-id="${appointment._id}">إرسال رسالة</button>
                            </div>
                        `;
                        appointmentsContainer.appendChild(div);
                    });
                }
                
                // إضافة أحداث للأزرار
                document.querySelectorAll('.btn-confirm').forEach(btn => {
                    btn.addEventListener('click', () => confirmAppointment(btn.dataset.id));
                });
                
                document.querySelectorAll('.btn-cancel').forEach(btn => {
                    btn.addEventListener('click', () => cancelAppointment(btn.dataset.id));
                });
                
                document.querySelectorAll('.btn-details').forEach(btn => {
                    btn.addEventListener('click', () => showAppointmentDetails(btn.dataset.id));
                });
                
                document.querySelectorAll('.btn-sms').forEach(btn => {
                    btn.addEventListener('click', () => showSMSModal(btn.dataset.id));
                });
                
                loader.style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading admin data:', error);
                loader.style.display = 'none';
                showAlert('error', error.message || 'حدث خطأ أثناء تحميل بيانات المدير');
            });
        }

        // إنشاء مخطط المواعيد
        function createAppointmentsChart() {
            const ctx = document.getElementById('appointmentsChart').getContext('2d');
            
            // بيانات المخطط
            const labels = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو'];
            const data = labels.map((_, index) => {
                return appointments.filter(app => {
                    const month = new Date(app.date).getMonth();
                    return month === index;
                }).length;
            });
            
            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'المواعيد',
                        data: data,
                        backgroundColor: 'rgba(106, 17, 203, 0.2)',
                        borderColor: 'rgba(106, 17, 203, 1)',
                        borderWidth: 1
                    }
                ]
            };
            
            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        },
                        title: {
                            display: true,
                            text: 'إحصائيات المواعيد الشهرية',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };
            
            new Chart(ctx, config);
        }

        // تحميل المواعيد
        function loadAppointments() {
            const filter = document.getElementById('appointmentsFilter').value;
            const searchTerm = document.getElementById('appointmentsSearch').value;
            
            let url = apiBase + '/appointments';
            const params = new URLSearchParams();
            
            if (filter === 'today') {
                params.append('date', new Date().toISOString().split('T')[0]);
            } else if (filter === 'upcoming') {
                params.append('status', 'جديد');
            } else if (filter === 'past') {
                params.append('status', 'مكتمل');
            }
            
            if (searchTerm) {
                params.append('search', searchTerm);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            fetch(url, {
                headers: getHeaders()
            })
            .then(async res => {
                if (!res.ok) throw new Error('فشل تحميل المواعيد');
                return res.json();
            })
            .then(appointments => {
            const tableBody = document.getElementById('appointmentsTableBody');
            tableBody.innerHTML = '';
            
                if (appointments.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="7" style="text-align:center">لا توجد مواعيد</td>';
                tableBody.appendChild(tr);
            } else {
                    appointments.forEach(appointment => {
                        const patient = appointment.patientId;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td>${patient?.phone || 'غير محدد'}</td>
                        <td>${patient?.name || 'مريض غير معروف'}</td>
                            <td>${new Date(appointment.date).toLocaleDateString('ar-EG')}</td>
                        <td>${appointment.time}</td>
                        <td>${appointment.type}</td>
                        <td>
                            <span class="${appointment.status === 'مؤكد' ? 'status-confirmed' : 
                                         appointment.status === 'جديد' ? 'status-new' : 'status-cancelled'}">
                                ${appointment.status}
                            </span>
                        </td>
                        <td>
                                <button class="action-btn upload-btn" data-id="${appointment._id}" title="رفع نتيجة التحليل"><i class="fas fa-upload"></i></button>
                                <button class="action-btn delete-btn" data-id="${appointment._id}" title="حذف الموعد"><i class="fas fa-trash"></i></button>
                                <button class="action-btn view-btn" data-id="${appointment._id}" title="عرض معلومات المريض"><i class="fas fa-eye"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            
            // إضافة أحداث للأزرار
                document.querySelectorAll('.upload-btn').forEach(btn => {
                    btn.addEventListener('click', () => showUploadResultModal(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteAppointment(btn.dataset.id));
            });
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewPatientDetails(btn.dataset.id));
                });
            })
            .catch(error => {
                console.error('Error loading appointments:', error);
                showAlert('error', error.message || 'حدث خطأ أثناء تحميل المواعيد');
            });
        }
        
        // دالة رفع نتيجة التحليل (إصلاح شامل)
        function showUploadResultModal(appointmentId) {
            const modal = document.getElementById('uploadResultModal');
            modal.style.display = 'flex';
            modal.dataset.appointmentId = appointmentId;

            // إزالة أي أحداث سابقة لمنع التكرار
            const uploadBtn = document.getElementById('uploadResultBtn');
            const newUploadBtn = uploadBtn.cloneNode(true);
            uploadBtn.parentNode.replaceChild(newUploadBtn, uploadBtn);

            document.getElementById('closeUploadResultModal').onclick = () => {
                modal.style.display = 'none';
            };
            newUploadBtn.onclick = () => {
                const fileInput = document.getElementById('testResultFile');
                const file = fileInput.files[0];
                if (!file) {
                    showAlert('error', 'الرجاء اختيار ملف');
                    return;
                }
                if (file.type !== 'application/pdf') {
                    showAlert('error', 'الرجاء اختيار ملف PDF');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = e.target.result;
                    loader.style.display = 'flex';
                    fetch(apiBase + '/test-results', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            appointmentId: appointmentId,
                            type: 'تحليل دم شامل',
                            fileUrl: fileData,
                            fileName: file.name,
                            fileSize: file.size
                        })
                    })
                    .then(async res => {
                        loader.style.display = 'none';
                        if (!res.ok) throw new Error('فشل رفع النتيجة');
                        return res.json();
                    })
                    .then(data => {
                        modal.style.display = 'none';
                        fileInput.value = '';
                        if (data.message) {
                            showAlert('success', data.message);
                            loadAppointments();
                        } else {
                            showAlert('error', 'حدث خطأ أثناء رفع النتيجة');
                        }
                    })
                    .catch(error => {
                        loader.style.display = 'none';
                        showAlert('error', error.message || 'تعذر الاتصال بالخادم');
                    });
                };
                reader.readAsDataURL(file);
            };
        }
        
        // دالة حذف الموعد
        function deleteAppointment(appointmentId) {
            if (confirm('هل أنت متأكد من حذف هذا الموعد؟')) {
                fetch(apiBase + `/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                })
                .then(async res => {
                    if (!res.ok) throw new Error('فشل حذف الموعد');
                    return res.json();
                })
                .then(data => {
                    if (data.message) {
                        showAlert('success', data.message);
                        loadAppointments();
                    } else {
                        showAlert('error', 'حدث خطأ أثناء حذف الموعد');
                    }
                })
                .catch(error => {
                    console.error('Error deleting appointment:', error);
                    showAlert('error', error.message || 'تعذر الاتصال بالخادم');
                });
            }
        }
        
        // دالة عرض تفاصيل المريض
        function viewPatientDetails(appointmentId) {
            const appointment = appointments.find(a => a.id == appointmentId);
            if (!appointment) {
                alert('لم يتم العثور على الموعد');
                return;
            }
            
            const patient = users.find(p => p.id === appointment.patientId);
            if (!patient) {
                alert('لم يتم العثور على بيانات المريض');
                return;
            }
            
            const modal = document.getElementById('viewPatientModal');
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="appointment-form">
                    <div class="form-header">
                        <h2>معلومات المريض والموعد</h2>
                        <button class="close-button" onclick="document.getElementById('viewPatientModal').style.display='none'">&times;</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; border: 1px solid #dee2e6;">
                            <h3 style="color: #6a11cb; margin-bottom: 15px; border-bottom: 2px solid #6a11cb; padding-bottom: 5px; text-align: center;">معلومات المريض</h3>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">اسم المريض</label>
                                <input type="text" value="${patient.name}" readonly style="background-color: white; border: 1px solid #ced4da;">
                            </div>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">رقم الهاتف</label>
                                <input type="text" value="${patient.phone}" readonly style="background-color: white; border: 1px solid #ced4da;">
                            </div>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">البريد الإلكتروني</label>
                                <input type="text" value="${patient.email || 'لا يوجد'}" readonly style="background-color: white; border: 1px solid #ced4da;">
                            </div>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">تاريخ التسجيل</label>
                                <input type="text" value="${patient.createdAt ? new Date(patient.createdAt).toLocaleDateString('ar-EG') : 'غير محدد'}" readonly style="background-color: white; border: 1px solid #ced4da;">
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; border: 1px solid #dee2e6;">
                            <h3 style="color: #6a11cb; margin-bottom: 15px; border-bottom: 2px solid #6a11cb; padding-bottom: 5px; text-align: center;">تفاصيل الموعد</h3>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">نوع التحليل</label>
                                <input type="text" value="${appointment.type}" readonly style="background-color: white; border: 1px solid #ced4da;">
                            </div>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">تاريخ الموعد</label>
                                <input type="text" value="${appointment.date}" readonly style="background-color: white; border: 1px solid #ced4da;">
                            </div>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">وقت الموعد</label>
                                <input type="text" value="${appointment.time}" readonly style="background-color: white; border: 1px solid #ced4da;">
                            </div>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; color: #495057;">حالة الموعد</label>
                                <input type="text" value="${appointment.status}" readonly style="background-color: white; border: 1px solid #ced4da; color: ${appointment.status === 'مؤكد' ? '#28a745' : appointment.status === 'جديد' ? '#17a2b8' : '#dc3545'}; font-weight: bold;">
                            </div>
                        </div>
                    </div>
                    
                    ${appointment.notes ? `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; margin-bottom: 20px;">
                        <h3 style="color: #6a11cb; margin-bottom: 15px; border-bottom: 2px solid #6a11cb; padding-bottom: 5px; text-align: center;">ملاحظات الموعد</h3>
                        <div class="form-group">
                            <textarea readonly style="background-color: white; border: 1px solid #ced4da; min-height: 80px; width: 100%; padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.5;">${appointment.notes}</textarea>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                        <h3 style="color: #6a11cb; margin-bottom: 15px; text-align: center;">الإجراءات</h3>
                        <button type="button" class="auth-button" onclick="document.getElementById('viewPatientModal').style.display='none'" style="width: auto; padding: 12px 30px; margin-left: 10px; background: linear-gradient(to right, #6c757d, #495057);">إغلاق</button>
                        <button type="button" class="auth-button" onclick="sendSMSToPatient('${patient.phone}', '${patient.name}')" style="width: auto; padding: 12px 30px; background: linear-gradient(to right, #28a745, #20c997);">إرسال رسالة</button>
                    </div>
                </div>
            `;
        }

        // تحميل التحاليل
        function loadTests() {
            const tableBody = document.getElementById('testsTableBody');
            tableBody.innerHTML = '';
            
            if (tests.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align:center">لا توجد تحاليل</td>';
                tableBody.appendChild(tr);
            } else {
                tests.forEach(test => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${test.id}</td>
                        <td>${test.name}</td>
                        <td>${test.price} ج.م</td>
                        <td>${test.waitingTime} يوم</td>
                        <td>${test.available ? 'نعم' : 'لا'}</td>
                        <td>
                            <button class="action-btn edit-btn" data-id="${test.id}"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" data-id="${test.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            
            // إضافة أحداث للأزرار
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => showEditTestModal(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteTest(btn.dataset.id));
            });
            
            // تعريف الدوال الجديدة
            function showEditTestModal(testId) {
                const test = tests.find(t => t.id == testId);
                if (!test) return;
                
                const modal = document.getElementById('addTestModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="appointment-form">
                        <div class="form-header">
                            <h2>تعديل التحليل</h2>
                            <button class="close-button" onclick="document.getElementById('addTestModal').style.display='none'">&times;</button>
                        </div>
                        
                        <div class="form-group">
                            <label>اسم التحليل</label>
                            <input type="text" id="testName" value="${test.name}">
                        </div>
                        
                        <div class="form-group">
                            <label>السعر (ج.م)</label>
                            <input type="number" id="testPrice" value="${test.price}">
                        </div>
                        
                        <div class="form-group">
                            <label>وقت الانتظار (يوم)</label>
                            <input type="number" id="testWaitingTime" value="${test.waitingTime}">
                        </div>
                        
                        <div class="form-group">
                            <label>متوفر</label>
                            <select id="testAvailable">
                                <option value="true" ${test.available ? 'selected' : ''}>نعم</option>
                                <option value="false" ${!test.available ? 'selected' : ''}>لا</option>
                            </select>
                        </div>
                        
                        <button type="button" class="auth-button" onclick="saveTestChanges(${testId})">حفظ التغييرات</button>
                    </div>
                `;
            }
            
            function saveTestChanges(testId) {
                const test = tests.find(t => t.id == testId);
                if (!test) return;
                
                const name = document.getElementById('testName').value.trim();
                const price = parseFloat(document.getElementById('testPrice').value);
                const waitingTime = parseInt(document.getElementById('testWaitingTime').value);
                const available = document.getElementById('testAvailable').value === 'true';
                
                if (!name || isNaN(price) || isNaN(waitingTime)) {
                    alert('الرجاء ملء جميع الحقول بشكل صحيح');
                    return;
                }
                
                test.name = name;
                test.price = price;
                test.waitingTime = waitingTime;
                test.available = available;
                
                saveData();
                loadTests();
                document.getElementById('addTestModal').style.display = 'none';
                alert('تم حفظ التغييرات بنجاح');
            }
            
            function deleteTest(testId) {
                if (confirm('هل أنت متأكد من حذف هذا التحليل؟')) {
                    tests = tests.filter(t => t.id != testId);
                    saveData();
                    loadTests();
                    alert('تم حذف التحليل بنجاح');
                }
            }
        }

        // تحميل الأطباء
        function loadDoctors() {
            const tableBody = document.getElementById('doctorsTableBody');
            tableBody.innerHTML = '';
            
            if (doctors.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align:center">لا توجد بيانات للأطباء</td>';
                tableBody.appendChild(tr);
            } else {
                doctors.forEach(doctor => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${doctor.id}</td>
                        <td>${doctor.name}</td>
                        <td>${doctor.specialty}</td>
                        <td>${doctor.phone}</td>
                        <td>${doctor.email || 'لا يوجد'}</td>
                        <td>
                            <button class="action-btn edit-btn" data-id="${doctor.id}"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" data-id="${doctor.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            
            // إضافة أحداث للأزرار
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => showEditDoctorModal(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteDoctor(btn.dataset.id));
            });
            
            // تعريف الدوال الجديدة
            function showEditDoctorModal(doctorId) {
                const doctor = doctors.find(d => d.id == doctorId);
                if (!doctor) return;
                
                const modal = document.getElementById('addDoctorModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="appointment-form">
                        <div class="form-header">
                            <h2>تعديل بيانات الطبيب</h2>
                            <button class="close-button" onclick="document.getElementById('addDoctorModal').style.display='none'">&times;</button>
                        </div>
                        
                        <div class="form-group">
                            <label>اسم الطبيب</label>
                            <input type="text" id="doctorName" value="${doctor.name}">
                        </div>
                        
                        <div class="form-group">
                            <label>التخصص</label>
                            <input type="text" id="doctorSpecialty" value="${doctor.specialty}">
                        </div>
                        
                        <div class="form-group">
                            <label>رقم الهاتف</label>
                            <input type="tel" id="doctorPhone" value="${doctor.phone}">
                        </div>
                        
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="doctorEmail" value="${doctor.email || ''}">
                        </div>
                        
                        <button type="button" class="auth-button" onclick="saveDoctorChanges(${doctorId})">حفظ التغييرات</button>
                    </div>
                `;
            }
            
            function saveDoctorChanges(doctorId) {
                const doctor = doctors.find(d => d.id == doctorId);
                if (!doctor) return;
                
                const name = document.getElementById('doctorName').value.trim();
                const specialty = document.getElementById('doctorSpecialty').value.trim();
                const phone = document.getElementById('doctorPhone').value.trim();
                const email = document.getElementById('doctorEmail').value.trim();
                
                if (!name || !specialty || !phone) {
                    alert('الرجاء ملء الحقول الإلزامية');
                    return;
                }
                
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    alert('البريد الإلكتروني غير صالح');
                    return;
                }
                
                doctor.name = name;
                doctor.specialty = specialty;
                doctor.phone = phone;
                doctor.email = email || null;
                
                saveData();
                loadDoctors();
                document.getElementById('addDoctorModal').style.display = 'none';
                alert('تم حفظ التغييرات بنجاح');
            }
            
            function deleteDoctor(doctorId) {
                if (confirm('هل أنت متأكد من حذف هذا الطبيب؟')) {
                    doctors = doctors.filter(d => d.id != doctorId);
                    saveData();
                    loadDoctors();
                    alert('تم حذف الطبيب بنجاح');
                }
            }
        }

        // تحميل المرضى من الـ backend
        function loadPatients() {
            const tableBody = document.getElementById('patientsTableBody');
            tableBody.innerHTML = '';
            loader.style.display = 'flex';
            fetch(apiBase + '/patients', { headers: getHeaders() })
                .then(async res => {
                    loader.style.display = 'none';
                    if (!res.ok) throw new Error('فشل تحميل المرضى');
                    return res.json();
                })
                .then(patients => {
            if (patients.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align:center">لا توجد بيانات للمرضى</td>';
                tableBody.appendChild(tr);
            } else {
                patients.forEach(patient => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                                <td>${patient._id}</td>
                        <td>${patient.name}</td>
                        <td>${patient.phone}</td>
                        <td>${patient.email || 'لا يوجد'}</td>
                                <td>${patient.createdAt ? patient.createdAt.split('T')[0] : 'غير محدد'}</td>
                        <td>
                                    <button class="action-btn view-btn" data-id="${patient._id}"><i class="fas fa-eye"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => viewPatient(btn.dataset.id));
            });
                })
                .catch(error => {
                    loader.style.display = 'none';
                    showAlert('error', error.message || 'تعذر الاتصال بالخادم');
            });
        }

        // عرض بيانات المريض
        function viewPatient(patientId) {
            const patient = users.find(p => p.id == patientId);
            if (!patient) return;
            
            appointmentModal.style.display = 'flex';
            appointmentModal.innerHTML = `
                <div class="appointment-form">
                    <div class="form-header">
                        <h2>بيانات المريض</h2>
                        <button class="close-button" id="closeAppointmentModal">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label>اسم المريض</label>
                        <input type="text" value="${patient.name}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="text" value="${patient.phone}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="text" value="${patient.email || 'لا يوجد'}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>تاريخ التسجيل</label>
                        <input type="text" value="${patient.createdAt.split('T')[0]}" readonly>
                    </div>
                    
                    <button type="button" class="auth-button" id="closeViewBtn">إغلاق</button>
                </div>
            `;
            
            document.getElementById('closeAppointmentModal').addEventListener('click', () => {
                appointmentModal.style.display = 'none';
            });
            
            document.getElementById('closeViewBtn').addEventListener('click', () => {
                appointmentModal.style.display = 'none';
            });
        }

        // حذف المريض
        function deletePatient(patientId) {
            if (confirm('هل أنت متأكد من حذف هذا المريض؟')) {
                users = users.filter(p => p.id != patientId);
                saveData();
                loadPatients();
                showAlert('success', 'تم حذف المريض بنجاح');
            }
        }

        // تحميل الاستشارات
        function loadConsultations() {
            const consultationsList = document.getElementById('consultationsList');
            consultationsList.innerHTML = '';
            
            const filter = document.getElementById('consultationsFilter').value;
            let filteredConsultations = [];
            
            if (filter === 'pending') {
                filteredConsultations = consultations.filter(c => c.status === 'pending');
            } else if (filter === 'answered') {
                filteredConsultations = consultations.filter(c => c.status === 'answered');
            } else {
                filteredConsultations = [...consultations];
            }
            
            if (filteredConsultations.length === 0) {
                consultationsList.innerHTML = '<p>لا توجد استشارات</p>';
            } else {
                filteredConsultations.forEach(consultation => {
                    const patient = users.find(p => p.id === consultation.patientId);
                    const div = document.createElement('div');
                    div.className = 'consultation-card';
                    div.innerHTML = `
                        <h3>${consultation.subject}</h3>
                        <p>المريض: ${patient?.name || 'مريض غير معروف'}</p>
                        <p>التاريخ: ${consultation.date}</p>
                        <p>الحالة: ${consultation.status === 'pending' ? 'قيد الانتظار' : 'تم الرد'}</p>
                        
                        <div class="consultation-messages">
                            <div class="message message-patient">
                                <p>${consultation.message}</p>
                                <div class="message-time">${new Date(consultation.createdAt).toLocaleString()}</div>
                            </div>
                            
                            ${consultation.reply ? `
                            <div class="message message-doctor">
                                <p>${consultation.reply}</p>
                                <div class="message-time">${new Date(consultation.replyDate).toLocaleString()}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${consultation.status === 'pending' ? `
                        <div class="consultation-reply">
                            <textarea id="reply-${consultation.id}" placeholder="أدخل ردك هنا..."></textarea>
                            <button class="auth-button" data-id="${consultation.id}" id="replyBtn">إرسال الرد</button>
                        </div>
                        ` : `
                        <button class="auth-button" data-id="${consultation.id}" id="chatBtn">فتح الدردشة</button>
                        `}
                    `;
                    consultationsList.appendChild(div);
                });
                
                // إضافة أحداث لأزرار الرد والدردشة
                document.querySelectorAll('#replyBtn').forEach(btn => {
                    btn.addEventListener('click', () => sendConsultationReply(btn.dataset.id));
                });
                
                document.querySelectorAll('#chatBtn').forEach(btn => {
                    btn.addEventListener('click', () => startChat(btn.dataset.id));
                });
            }
        }

        // بدء الدردشة
        function startChat(consultationId) {
            const consultation = consultations.find(c => c.id == consultationId);
            if (!consultation) return;
            
            activeConsultation = consultation;
            
            // محاكاة اتصال WebSocket (في تطبيق حقيقي، سيتم استخدام WebSocket فعلي)
            if (!chatSocket) {
                chatSocket = {
                    send: function(message) {
                        // محاكاة استقبال الرسالة بعد ثانية
                        setTimeout(() => {
                            receiveMessage({
                                consultationId: consultation.id,
                                sender: isAdmin ? 'doctor' : 'patient',
                                message: message,
                                timestamp: new Date().toISOString()
                            });
                        }, 1000);
                    },
                    close: function() {
                        chatSocket = null;
                    }
                };
            }
            
            showChat(consultationId);
        }

        // استقبال رسالة في الدردشة
        function receiveMessage(messageData) {
            if (!activeConsultation || activeConsultation.id != messageData.consultationId) return;
            
            // إضافة الرسالة إلى الاستشارة
            if (!activeConsultation.messages) {
                activeConsultation.messages = [];
            }
            
            activeConsultation.messages.push({
                sender: messageData.sender,
                message: messageData.message,
                timestamp: messageData.timestamp
            });
            
            saveData();
            
            // تحديث عرض الدردشة إذا كانت مفتوحة
            if (chatContainer.style.display === 'flex') {
                updateChatMessages();
            }
        }

        // تحميل المخزون
        function loadInventory() {
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = '';
            
            if (inventory.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align:center">لا توجد مواد في المخزون</td>';
                tableBody.appendChild(tr);
            } else {
                inventory.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.reorderLevel}</td>
                        <td>${item.expiryDate}</td>
                        <td>
                            <button class="action-btn edit-btn" data-id="${item.id}" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" data-id="${item.id}" title="حذف"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            
            // إضافة أحداث للأزرار
            document.querySelectorAll('#inventoryTableBody .edit-btn').forEach(btn => {
                btn.addEventListener('click', () => showEditInventoryModal(btn.dataset.id));
            });
            
            document.querySelectorAll('#inventoryTableBody .delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteInventoryItem(btn.dataset.id));
            });
            
            // إضافة حدث لزر إضافة مادة جديدة
            document.getElementById('addInventoryBtn').addEventListener('click', () => {
                showAddInventoryModal();
            });
        }
        
        function showAddInventoryModal() {
            const modal = document.getElementById('addInventoryModal');
            document.getElementById('inventoryModalTitle').textContent = 'إضافة مادة جديدة';
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemExpiry').value = '';
            
            document.getElementById('saveInventoryBtn').onclick = saveNewInventoryItem;
            modal.style.display = 'flex';
        }
        
        function showEditInventoryModal(itemId) {
            const item = inventory.find(i => i.id == itemId);
            if (!item) return;
            
            const modal = document.getElementById('addInventoryModal');
            document.getElementById('inventoryModalTitle').textContent = 'تعديل المادة';
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemExpiry').value = item.expiryDate;
            
            document.getElementById('saveInventoryBtn').onclick = () => saveInventoryChanges(itemId);
            modal.style.display = 'flex';
        }
        
        function saveNewInventoryItem() {
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const price = parseFloat(document.getElementById('itemPrice').value);
            const expiryDate = document.getElementById('itemExpiry').value;
            
            if (!name || isNaN(quantity) || isNaN(price) || !expiryDate) {
                alert('الرجاء ملء جميع الحقول بشكل صحيح');
                return;
            }
            
            const newItem = {
                id: Date.now(),
                name,
                quantity,
                price,
                expiryDate,
                reorderLevel: Math.floor(quantity * 0.2) // مستوى إعادة الطلب 20% من الكمية
            };
            
            inventory.push(newItem);
            saveData();
            loadInventory();
            document.getElementById('addInventoryModal').style.display = 'none';
            alert('تمت إضافة المادة بنجاح');
        }
        
        function saveInventoryChanges(itemId) {
            const item = inventory.find(i => i.id == itemId);
            if (!item) return;
            
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const price = parseFloat(document.getElementById('itemPrice').value);
            const expiryDate = document.getElementById('itemExpiry').value;
            
            if (!name || isNaN(quantity) || isNaN(price) || !expiryDate) {
                alert('الرجاء ملء جميع الحقول بشكل صحيح');
                return;
            }
            
            item.name = name;
            item.quantity = quantity;
            item.price = price;
            item.expiryDate = expiryDate;
            item.reorderLevel = Math.floor(quantity * 0.2);
            
            saveData();
            loadInventory();
            document.getElementById('addInventoryModal').style.display = 'none';
            alert('تم حفظ التغييرات بنجاح');
        }
        
        function deleteInventoryItem(itemId) {
            if (confirm('هل أنت متأكد من حذف هذه المادة؟')) {
                inventory = inventory.filter(i => i.id != itemId);
                                 saveData();
                 loadInventory();
                 alert('تم حذف المادة بنجاح');
             }
        }            
            // تحميل المواد المنتهية الصلاحية
            const expiredTableBody = document.getElementById('expiredInventoryTableBody');
            expiredTableBody.innerHTML = '';
            
            if (expiredInventory.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="5" style="text-align:center">لا توجد مواد منتهية الصلاحية</td>';
                expiredTableBody.appendChild(tr);
            } else {
                expiredInventory.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.expiryDate}</td>
                        <td>
                            <button class="action-btn delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    expiredTableBody.appendChild(tr);
                });
            }
            
            // إضافة أحداث للأزرار
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editInventoryItem(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteInventoryItem(btn.dataset.id));
            });
        

        // تحميل التقارير
        function loadReports() {
            const reportType = document.getElementById('reportType').value;
            const reportMonth = document.getElementById('reportMonth').value;
            
            // إنشاء مخطط التقارير
            createReportsChart(reportType, reportMonth);
            
            // تحميل بيانات الجدول
            const tableBody = document.getElementById('reportsTableBody');
            tableBody.innerHTML = '';
            
            // بيانات وهمية للتقرير
            const reportData = [
                { date: '2023-01-01', appointments: 15, revenue: 4500, popularTest: 'تحليل دم شامل' },
                { date: '2023-01-02', appointments: 12, revenue: 3600, popularTest: 'تحليل سكر' },
                { date: '2023-01-03', appointments: 18, revenue: 5400, popularTest: 'تحليل فيتامين د' }
            ];
            
            reportData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.appointments}</td>
                    <td>${item.revenue} ج.م</td>
                    <td>${item.popularTest}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // إنشاء مخطط التقارير
        function createReportsChart(reportType, reportMonth) {
            const ctx = document.getElementById('reportsChart').getContext('2d');
            
            // بيانات وهمية حسب نوع التقرير
            let labels, data;
            
            if (reportType === 'monthly') {
                labels = ['الأسبوع 1', 'الأسبوع 2', 'الأسبوع 3', 'الأسبوع 4'];
                data = [120, 190, 150, 200];
            } else if (reportType === 'daily') {
                labels = ['8-10', '10-12', '12-2', '2-4', '4-6'];
                data = [50, 80, 120, 90, 60];
            } else {
                labels = tests.slice(0, 5).map(t => t.name);
                data = [30, 45, 25, 60, 40];
            }
            
            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: reportType === 'tests' ? 'عدد الطلبات' : 'عدد المواعيد',
                        data: data,
                        backgroundColor: 'rgba(106, 17, 203, 0.2)',
                        borderColor: 'rgba(106, 17, 203, 1)',
                        borderWidth: 1
                    }
                ]
            };
            
            const config = {
                type: reportType === 'tests' ? 'pie' : 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        },
                        title: {
                            display: true,
                            text: reportType === 'monthly' ? 'تقرير شهري' : 
                                  reportType === 'daily' ? 'تقرير يومي' : 'أكثر التحاليل طلباً',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: reportType === 'tests' ? {} : {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };
            
            // تدمير المخطط القديم إذا كان موجوداً
            if (window.reportsChart) {
                window.reportsChart.destroy();
            }
            
            window.reportsChart = new Chart(ctx, config);
        }

        // تحميل الإعدادات
        function loadSettings() {
            // تحميل إعدادات النظام
            document.getElementById('labName').value = systemSettings.labName || '';
            document.getElementById('labAddress').value = systemSettings.labAddress || '';
            document.getElementById('labPhone').value = systemSettings.labPhone || '';
            document.getElementById('labEmail').value = systemSettings.labEmail || '';
            document.getElementById('workingHours').value = systemSettings.workingHours || '';
            
            // تحميل إعدادات الحساب
            document.getElementById('adminName').value = currentUser.name || '';
            document.getElementById('adminEmail').value = currentUser.email || '';
            document.getElementById('adminPhone').value = currentUser.phone || '';
            
            // إضافة أحداث للنماذج
            document.getElementById('systemSettingsForm').addEventListener('submit', saveSystemSettings);
            document.getElementById('accountSettingsForm').addEventListener('submit', saveAccountSettings);
        }

        // تأكيد الموعد
        function confirmAppointment(appointmentId) {
            fetch(apiBase + `/appointments/${appointmentId}/status`, {
                method: 'PATCH',
                headers: getHeaders(),
                body: JSON.stringify({ status: 'مؤكد' })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    showAlert('success', data.message);
                loadAdminData();
                } else {
                    showAlert('error', 'حدث خطأ أثناء تأكيد الموعد');
                }
            })
            .catch(error => {
                console.error('Error confirming appointment:', error);
                showAlert('error', 'تعذر الاتصال بالخادم');
            });
        }

        // إلغاء الموعد
        function cancelAppointment(appointmentId) {
            fetch(apiBase + `/appointments/${appointmentId}/status`, {
                method: 'PATCH',
                headers: getHeaders(),
                body: JSON.stringify({ status: 'ملغى' })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    showAlert('success', data.message);
                loadAdminData();
                } else {
                    showAlert('error', 'حدث خطأ أثناء إلغاء الموعد');
                }
            })
            .catch(error => {
                console.error('Error cancelling appointment:', error);
                showAlert('error', 'تعذر الاتصال بالخادم');
            });
        }

        // عرض تفاصيل الموعد
        function showAppointmentDetails(appointmentId) {
            const appointment = appointments.find(a => a.id == appointmentId);
            if (!appointment) return;
            
            const patient = users.find(p => p.id === appointment.patientId);
            
            appointmentModal.style.display = 'flex';
            appointmentModal.innerHTML = `
                <div class="appointment-form">
                    <div class="form-header">
                        <h2>تفاصيل الموعد</h2>
                        <button class="close-button" id="closeAppointmentModal">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label>اسم المريض</label>
                        <input type="text" value="${patient?.name || 'مريض غير معروف'}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>نوع التحليل</label>
                        <input type="text" value="${appointment.type}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>التاريخ</label>
                        <input type="text" value="${appointment.date}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>الوقت</label>
                        <input type="text" value="${appointment.time}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>الحالة</label>
                        <input type="text" value="${appointment.status}" readonly>
                    </div>
                    
                    ${appointment.notes ? `
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea readonly>${appointment.notes}</textarea>
                    </div>
                    ` : ''}
                    
                    <div class="form-group">
                        <label>رفع نتيجة تحليل</label>
                        <input type="file" id="testResultFile">
                        <button type="button" class="auth-button" id="uploadResultBtn">رفع النتيجة</button>
                    </div>
                </div>
            `;
            
            document.getElementById('closeAppointmentModal').addEventListener('click', () => {
                appointmentModal.style.display = 'none';
            });
            
            document.getElementById('uploadResultBtn').addEventListener('click', () => {
                uploadTestResult(appointmentId);
            });
        }

        // رفع نتيجة التحليل
        function uploadTestResult(appointmentId) {
            const fileInput = document.getElementById('testResultFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('error', 'يرجى اختيار ملف النتيجة أولاً');
                return;
            }
            
            // تحويل الملف إلى base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileData = e.target.result;
                
            loader.style.display = 'flex';
            
                fetch(apiBase + '/test-results', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        appointmentId: appointmentId,
                        type: 'تحليل دم شامل',
                        fileUrl: fileData,
                        fileName: file.name,
                        fileSize: file.size
                    })
                })
                .then(async res => {
                loader.style.display = 'none';
                    if (!res.ok) throw new Error('فشل رفع النتيجة');
                    return res.json();
                })
                .then(data => {
                uploadResultModal.style.display = 'none';
                    fileInput.value = '';
                    
                    if (data.message) {
                        showAlert('success', data.message);
                        loadAppointments();
                    } else {
                        showAlert('error', 'حدث خطأ أثناء رفع النتيجة');
                    }
                })
                .catch(error => {
                    console.error('Error uploading test result:', error);
                    loader.style.display = 'none';
                    showAlert('error', error.message || 'تعذر الاتصال بالخادم');
                });
            };
            
            reader.readAsDataURL(file);
        }

        // عرض نموذج إرسال SMS
        function showSMSModal(appointmentId) {
            const appointment = appointments.find(a => a.id == appointmentId);
            if (!appointment) return;
            
            const patient = users.find(p => p.id === appointment.patientId);
            
            smsModal.style.display = 'flex';
            smsModal.innerHTML = `
                <div class="sms-form">
                    <div class="form-header">
                        <h2>إرسال رسالة SMS</h2>
                        <button class="close-button" id="closeSMSModal">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label>إلى</label>
                        <input type="text" value="${patient?.phone || 'لا يوجد رقم هاتف'}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>الرسالة</label>
                        <textarea id="smsMessage" rows="5">عزيزي ${patient?.name || 'العميل'}، نود تذكيرك بموعدك في معمل أمان بتاريخ ${appointment.date} الساعة ${appointment.time}.</textarea>
                    </div>
                    
                    <button type="button" class="auth-button" id="sendSMSBtn">إرسال الرسالة</button>
                </div>
            `;
            
            document.getElementById('closeSMSModal').addEventListener('click', () => {
                smsModal.style.display = 'none';
            });
            
            document.getElementById('sendSMSBtn').addEventListener('click', () => {
                sendSMS(appointmentId);
            });
        }

        // إرسال SMS
        function sendSMS(appointmentId) {
            const message = document.getElementById('smsMessage').value;
            
            if (!message) {
                showAlert('error', 'يرجى كتابة محتوى الرسالة');
                return;
            }
            
            // محاكاة إرسال الرسالة
            loader.style.display = 'flex';
            
            setTimeout(() => {
                loader.style.display = 'none';
                smsModal.style.display = 'none';
                showAlert('success', 'تم إرسال الرسالة بنجاح');
            }, 1000);
        }
        
        // إرسال رسالة للمريض
        function sendSMSToPatient(phone, patientName) {
            const message = prompt(`أدخل الرسالة التي تريد إرسالها إلى ${patientName}:`);
            
            if (message && message.trim()) {
                // محاكاة إرسال الرسالة
                loader.style.display = 'flex';
                
                setTimeout(() => {
                    loader.style.display = 'none';
                    showAlert('success', `تم إرسال الرسالة إلى ${patientName} بنجاح`);
                }, 1000);
            }
        }

        // عرض نموذج حجز موعد
        function showAppointmentModal() {
            appointmentModal.style.display = 'flex';
            
            // إنشاء محتوى النموذج
            appointmentModal.innerHTML = `
                <div class="appointment-form">
                    <div class="form-header">
                        <h2>حجز موعد جديد</h2>
                        <button class="close-button" id="closeAppointmentModal">&times;</button>
                    </div>
                    <div class="form-group">
                        <label for="appointmentType">نوع التحليل</label>
                        <select id="appointmentType" required>
                            <option value="">اختر نوع التحليل</option>
                            <option value="تحليل دم شامل">تحليل دم شامل</option>
                            <option value="تحليل سكر">تحليل سكر</option>
                            <option value="تحليل حمل">تحليل حمل</option>
                            <option value="تحليل فيتامين د">تحليل فيتامين د</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointmentDate">تاريخ الموعد</label>
                        <input type="date" id="appointmentDate" required>
                    </div>
                                         <div class="form-group">
                        <label for="appointmentTime">وقت الموعد</label>
                        <select id="appointmentTime" required>
                            <option value="">اختر الوقت</option>
                            <option value="09:00 ص">09:00 ص</option>
                            <option value="10:00 ص">10:00 ص</option>
                            <option value="11:00 ص">11:00 ص</option>
                            <option value="12:00 م">12:00 م</option>
                            <option value="01:00 م">01:00 م</option>
                            <option value="02:00 م">02:00 م</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointmentNotes">ملاحظات (اختياري)</label>
                        <textarea id="appointmentNotes" placeholder="أي ملاحظات إضافية"></textarea>
                    </div>
                    <button type="button" class="auth-button" id="submitAppointmentBtn">حجز الموعد</button>
                </div>
            `;
            
            // تعيين الحد الأدنى لتاريخ الحجز (اليوم)
            document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
            
            // إضافة أحداث النموذج
            document.getElementById('closeAppointmentModal').addEventListener('click', () => {
                appointmentModal.style.display = 'none';
            });
            
            document.getElementById('submitAppointmentBtn').addEventListener('click', () => {
                bookAppointment();
            });
        }

        // حجز موعد جديد
        function bookAppointment() {
            const type = document.getElementById('appointmentType').value;
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const notes = document.getElementById('appointmentNotes').value;
            
            if (!type || !date || !time) {
                showAlert('error', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            loader.style.display = 'flex';
            fetch(apiBase + '/appointments', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ type, date, time, notes })
            })
            .then(async res => {
                loader.style.display = 'none';
                if (!res.ok) throw new Error('فشل حجز الموعد');
                return res.json();
            })
            .then(data => {
                appointmentModal.style.display = 'none';
                
                if (data.message) {
                    showAlert('success', data.message);
                loadUserData(currentUser);
                } else {
                    showAlert('error', 'حدث خطأ أثناء حجز الموعد');
                }
            })
            .catch(error => {
                console.error('Error booking appointment:', error);
                loader.style.display = 'none';
                showAlert('error', error.message || 'تعذر الاتصال بالخادم');
            });
        }

        // عرض نموذج الاستشارة الطبية
        function showConsultationModal() {
            consultationModal.style.display = 'flex';
            
            consultationModal.innerHTML = `
                <div class="consultation-form">
                    <div class="form-header">
                        <h2>استشارة طبية</h2>
                        <button class="close-button" id="closeConsultationModal">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="consultationSubject">موضوع الاستشارة</label>
                        <input type="text" id="consultationSubject" placeholder="أدخل موضوع الاستشارة" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="consultationMessage">تفاصيل الاستشارة</label>
                        <textarea id="consultationMessage" rows="5" placeholder="أدخل تفاصيل استشارتك هنا..." required></textarea>
                    </div>
                    
                    <button type="button" class="auth-button" id="submitConsultationBtn">إرسال الاستشارة</button>
                </div>
            `;
            
            document.getElementById('closeConsultationModal').addEventListener('click', () => {
                consultationModal.style.display = 'none';
            });
            
            document.getElementById('submitConsultationBtn').addEventListener('click', () => {
                submitConsultation();
            });
        }

        // إرسال استشارة طبية
        function submitConsultation() {
            const subject = document.getElementById('consultationSubject').value.trim();
            const message = document.getElementById('consultationMessage').value.trim();
            
            if (!subject || !message) {
                showAlert('error', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            loader.style.display = 'flex';
            
            fetch(apiBase + '/consultations', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ subject, message })
            })
            .then(async res => {
                loader.style.display = 'none';
                if (!res.ok) throw new Error('فشل إرسال الاستشارة');
                return res.json();
            })
            .then(data => {
                consultationModal.style.display = 'none';
                
                if (data.message) {
                    showAlert('success', data.message);
                } else {
                    showAlert('error', 'حدث خطأ أثناء إرسال الاستشارة');
                }
            })
            .catch(error => {
                console.error('Error submitting consultation:', error);
                loader.style.display = 'none';
                showAlert('error', error.message || 'تعذر الاتصال بالخادم');
            });
        }

        // عرض الدردشة
        function showChat(consultationId) {
            const consultation = consultations.find(c => c.id == consultationId);
            if (!consultation) return;
            
            chatContainer.style.display = 'flex';
            
            // تحديث عنوان الدردشة
            chatContainer.innerHTML = `
                <div class="chat-header">
                    <h3>${consultation.subject}</h3>
                    <button class="close-chat" id="closeChatBtn">&times;</button>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="chatMessageInput" placeholder="اكتب رسالتك هنا...">
                    <button id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            `;
            
            // تحديث الرسائل
            updateChatMessages();
            
            // إضافة أحداث الدردشة
            document.getElementById('closeChatBtn').addEventListener('click', () => {
                chatContainer.style.display = 'none';
            });
            
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            
            document.getElementById('chatMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // تحديث رسائل الدردشة
        function updateChatMessages() {
            if (!activeConsultation) return;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // عرض الرسالة الأصلية
            const patientMessage = document.createElement('div');
            patientMessage.className = 'message message-patient';
            patientMessage.innerHTML = `
                <p>${activeConsultation.message}</p>
                <div class="message-time">${new Date(activeConsultation.createdAt).toLocaleString()}</div>
            `;
            chatMessages.appendChild(patientMessage);
            
            // عرض الرد إذا وجد
            if (activeConsultation.reply) {
                const doctorMessage = document.createElement('div');
                doctorMessage.className = 'message message-doctor';
                doctorMessage.innerHTML = `
                    <p>${activeConsultation.reply}</p>
                    <div class="message-time">${new Date(activeConsultation.replyDate).toLocaleString()}</div>
                `;
                chatMessages.appendChild(doctorMessage);
            }
            
            // عرض أي رسائل إضافية
            if (activeConsultation.messages && activeConsultation.messages.length > 0) {
                activeConsultation.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message message-${msg.sender === 'doctor' ? 'doctor' : 'patient'}`;
                    messageDiv.innerHTML = `
                        <p>${msg.message}</p>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                    `;
                    chatMessages.appendChild(messageDiv);
                });
            }
            
            // التمرير إلى الأسفل
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // إرسال رسالة في الدردشة
        function sendMessage() {
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // إرسال الرسالة عبر WebSocket (محاكاة)
            if (chatSocket) {
                chatSocket.send(message);
                
                // إضافة الرسالة إلى الاستشارة
                if (!activeConsultation.messages) {
                    activeConsultation.messages = [];
                }
                
                activeConsultation.messages.push({
                    sender: isAdmin ? 'doctor' : 'patient',
                    message: message,
                    timestamp: new Date().toISOString()
                });
                
                saveData();
                
                // تحديث عرض الدردشة
                updateChatMessages();
                
                // مسح حقل الإدخال
                input.value = '';
            }
        }

        // إرسال رد على الاستشارة
        function sendConsultationReply(consultationId) {
            const replyText = document.getElementById(`reply-${consultationId}`).value.trim();
            
            if (!replyText) {
                showAlert('error', 'يرجى كتابة الرد');
                return;
            }
            
            // محاكاة إرسال الرد
            loader.style.display = 'flex';
            
            setTimeout(() => {
                loader.style.display = 'none';
                
                const consultation = consultations.find(c => c.id == consultationId);
                if (consultation) {
                    consultation.reply = replyText;
                    consultation.replyDate = new Date().toISOString();
                    consultation.status = 'answered';
                    saveData();
                    
                    // تحديث عرض الاستشارات
                    loadConsultations();
                    
                    // بدء الدردشة
                    startChat(consultationId);
                }
            }, 1000);
        }

        // عرض نموذج إضافة تحليل
        function showAddTestModal() {
            appointmentModal.style.display = 'flex';
            
            appointmentModal.innerHTML = `
                <div class="appointment-form">
                    <div class="form-header">
                        <h2>إضافة تحليل جديد</h2>
                        <button class="close-button" id="closeAppointmentModal">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="testName">اسم التحليل</label>
                        <input type="text" id="testName" placeholder="أدخل اسم التحليل" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="testPrice">السعر (ج.م)</label>
                        <input type="number" id="testPrice" placeholder="أدخل سعر التحليل" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="testWaitingTime">وقت الانتظار (أيام)</label>
                        <input type="number" id="testWaitingTime" placeholder="أدخل وقت الانتظار" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="testDescription">وصف التحليل (اختياري)</label>
                        <textarea id="testDescription" placeholder="أدخل وصفاً للتحليل"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="testAvailable" checked> متوفر
                        </label>
                    </div>
                    
                    <button type="button" class="auth-button" id="saveTestBtn">حفظ التحليل</button>
                </div>
            `;
            
            document.getElementById('closeAppointmentModal').addEventListener('click', () => {
                appointmentModal.style.display = 'none';
            });
            
            document.getElementById('saveTestBtn').addEventListener('click', () => {
                saveTest();
            });
        }

        // حفظ التحليل الجديد
        function saveTest() {
            const name = document.getElementById('testName').value.trim();
            const price = document.getElementById('testPrice').value.trim();
            const waitingTime = document.getElementById('testWaitingTime').value.trim();
            const description = document.getElementById('testDescription').value.trim();
            const available = document.getElementById('testAvailable').checked;
            
            if (!name || !price || !waitingTime) {
                showAlert('error', 'يرجى ملء الحقول المطلوبة');
                return;
            }
            
            // محاكاة حفظ التحليل
            loader.style.display = 'flex';
            
            setTimeout(() => {
                loader.style.display = 'none';
                
                // إنشاء تحليل جديد
                const newTest = {
                    id: Date.now(),
                    name,
                    price: parseFloat(price),
                    waitingTime: parseInt(waitingTime),
                    description: description || null,
                    available,
                    createdAt: new Date().toISOString()
                };
                
                // إضافة التحليل إلى القائمة
                tests.push(newTest);
                saveData();
                
                // إغلاق النموذج
                appointmentModal.style.display = 'none';
                
                // إظهار رسالة نجاح
                showAlert('success', 'تم إضافة التحليل بنجاح!');
                
                // تحديث قائمة التحاليل
                loadTests();
            }, 1000);
        }

        // عرض نموذج إضافة طبيب
        function showAddDoctorModal() {
            appointmentModal.style.display = 'flex';
            
            appointmentModal.innerHTML = `
                <div class="appointment-form">
                    <div class="form-header">
                        <h2>إضافة طبيب جديد</h2>
                        <button class="close-button" id="closeAppointmentModal">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="doctorName">اسم الطبيب</label>
                        <input type="text" id="doctorName" placeholder="أدخل اسم الطبيب" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="doctorSpecialty">التخصص</label>
                        <input type="text" id="doctorSpecialty" placeholder="أدخل تخصص الطبيب" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="doctorPhone">رقم الهاتف</label>
                        <input type="tel" id="doctorPhone" placeholder="أدخل رقم هاتف الطبيب" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="doctorEmail">البريد الإلكتروني (اختياري)</label>
                        <input type="email" id="doctorEmail" placeholder="أدخل البريد الإلكتروني">
                    </div>
                    
                    <button type="button" class="auth-button" id="saveDoctorBtn">حفظ الطبيب</button>
                </div>
            `;
            
            document.getElementById('closeAppointmentModal').addEventListener('click', () => {
                appointmentModal.style.display = 'none';
            });
            
            document.getElementById('saveDoctorBtn').addEventListener('click', () => {
                saveDoctor();
            });
        }

        // حفظ الطبيب الجديد
        function saveDoctor() {
            const name = document.getElementById('doctorName').value.trim();
            const specialty = document.getElementById('doctorSpecialty').value.trim();
            const phone = document.getElementById('doctorPhone').value.trim();
            const email = document.getElementById('doctorEmail').value.trim();
            
            if (!name || !specialty || !phone) {
                showAlert('error', 'يرجى ملء الحقول المطلوبة');
                return;
            }
            
            if (!/^[0-9]{10,15}$/.test(phone)) {
                showAlert('error', 'رقم الهاتف غير صالح');
                return;
            }
            
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showAlert('error', 'البريد الإلكتروني غير صالح');
                return;
            }
            
            // محاكاة حفظ الطبيب
            loader.style.display = 'flex';
            
            setTimeout(() => {
                loader.style.display = 'none';
                
                // إنشاء طبيب جديد
                const newDoctor = {
                    id: Date.now(),
                    name,
                    specialty,
                    phone,
                    email: email || null,
                    createdAt: new Date().toISOString()
                };
                
                // إضافة الطبيب إلى القائمة
                doctors.push(newDoctor);
                saveData();
                
                // إغلاق النموذج
                appointmentModal.style.display = 'none';
                
                // إظهار رسالة نجاح
                showAlert('success', 'تم إضافة الطبيب بنجاح!');
                
                // تحديث قائمة الأطباء
                loadDoctors();
            }, 1000);
        }

        // عرض نموذج إضافة مادة للمخزون
        function showAddInventoryModal() {
            appointmentModal.style.display = 'flex';
            
            appointmentModal.innerHTML = `
                <div class="appointment-form">
                    <div class="form-header">
                        <h2>إضافة مادة جديدة</h2>
                        <button class="close-button" id="closeAppointmentModal">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="inventoryName">اسم المادة</label>
                        <input type="text" id="inventoryName" placeholder="أدخل اسم المادة" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="inventoryQuantity">الكمية</label>
                        <input type="number" id="inventoryQuantity" placeholder="أدخل الكمية المتاحة" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="inventoryReorderLevel">حد الطلب</label>
                        <input type="number" id="inventoryReorderLevel" placeholder="أدخل الحد الأدنى للطلب" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="inventoryExpiryDate">تاريخ الصلاحية</label>
                        <input type="date" id="inventoryExpiryDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="inventoryNotes">ملاحظات (اختياري)</label>
                        <textarea id="inventoryNotes" placeholder="أي ملاحظات إضافية"></textarea>
                    </div>
                    
                    <button type="button" class="auth-button" id="saveInventoryBtn">حفظ المادة</button>
                </div>
            `;
            
            document.getElementById('closeAppointmentModal').addEventListener('click', () => {
                appointmentModal.style.display = 'none';
            });
            
            document.getElementById('saveInventoryBtn').addEventListener('click', () => {
                saveInventoryItem();
            });
        }

        // حفظ مادة المخزون الجديدة
        function saveInventoryItem() {
            const name = document.getElementById('inventoryName').value.trim();
            const quantity = document.getElementById('inventoryQuantity').value.trim();
            const reorderLevel = document.getElementById('inventoryReorderLevel').value.trim();
            const expiryDate = document.getElementById('inventoryExpiryDate').value;
            const notes = document.getElementById('inventoryNotes').value.trim();
            
            if (!name || !quantity || !reorderLevel || !expiryDate) {
                showAlert('error', 'يرجى ملء الحقول المطلوبة');
                return;
            }
            
            if (parseInt(quantity) < 0 || parseInt(reorderLevel) < 0) {
                showAlert('error', 'يجب أن تكون الكمية وحد الطلب أرقاماً موجبة');
                return;
            }
            
            // محاكاة حفظ المادة
            loader.style.display = 'flex';
            
            setTimeout(() => {
                loader.style.display = 'none';
                
                // إنشاء مادة جديدة
                const newItem = {
                    id: Date.now(),
                    name,
                    quantity: parseInt(quantity),
                    reorderLevel: parseInt(reorderLevel),
                    expiryDate,
                    notes: notes || null,
                    createdAt: new Date().toISOString()
                };
                
                // إضافة المادة إلى القائمة المناسبة
                if (new Date(expiryDate) < new Date()) {
                    expiredInventory.push(newItem);
                } else {
                    inventory.push(newItem);
                }
                
                saveData();
                
                // إغلاق النموذج
                appointmentModal.style.display = 'none';
                
                // إظهار رسالة نجاح
                showAlert('success', 'تم إضافة المادة بنجاح!');
                
                // تحديث قائمة المخزون
                loadInventory();
            }, 1000);
        }

        // حفظ إعدادات النظام
        function saveSystemSettings(e) {
            e.preventDefault();
            
            const labName = document.getElementById('labName').value.trim();
            const labAddress = document.getElementById('labAddress').value.trim();
            const labPhone = document.getElementById('labPhone').value.trim();
            const labEmail = document.getElementById('labEmail').value.trim();
            const workingHours = document.getElementById('workingHours').value.trim();
            
            if (!labName || !labAddress || !labPhone || !labEmail || !workingHours) {
                showAlert('error', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // محاكاة حفظ الإعدادات
            loader.style.display = 'flex';
            
            setTimeout(() => {
                loader.style.display = 'none';
                
                // تحديث إعدادات النظام
                systemSettings = {
                    labName,
                    labAddress,
                    labPhone,
                    labEmail,
                    workingHours
                };
                
                saveData();
                
                // إظهار رسالة نجاح
                showAlert('success', 'تم حفظ إعدادات النظام بنجاح!');
            }, 1000);
        }

        // حفظ إعدادات الحساب
        function saveAccountSettings(e) {
            e.preventDefault();
            
            const name = document.getElementById('adminName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const phone = document.getElementById('adminPhone').value.trim();
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmNewPassword = document.getElementById('confirmNewPassword').value.trim();
            
            if (!name || !email || !phone) {
                showAlert('error', 'يرجى ملء الحقول المطلوبة');
                return;
            }
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showAlert('error', 'البريد الإلكتروني غير صالح');
                return;
            }
            
            if (!/^[0-9]{10,15}$/.test(phone)) {
                showAlert('error', 'رقم الهاتف غير صالح');
                return;
            }
            
            // التحقق من كلمة المرور إذا تم تغييرها
            if (newPassword || confirmNewPassword || currentPassword) {
                if (!currentPassword) {
                    showAlert('error', 'يرجى إدخال كلمة المرور الحالية');
                    return;
                }
                
                if (currentPassword !== currentUser.password) {
                    showAlert('error', 'كلمة المرور الحالية غير صحيحة');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showAlert('error', 'كلمة المرور الجديدة يجب أن تكون 6 أحرف على الأقل');
                    return;
                }
                
                if (newPassword !== confirmNewPassword) {
                    showAlert('error', 'كلمة المرور الجديدة غير متطابقة');
                    return;
                }
            }
            
            // محاكاة حفظ الإعدادات
            loader.style.display = 'flex';
            
            setTimeout(() => {
                loader.style.display = 'none';
                
                // تحديث بيانات الحساب
                currentUser.name = name;
                currentUser.email = email;
                currentUser.phone = phone;
                
                if (newPassword) {
                    currentUser.password = newPassword;
                }
                
                // حفظ البيانات
                if (isAdmin) {
                    localStorage.setItem('loggedInAdmin', JSON.stringify(currentUser));
                } else {
                    localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                }
                
                // إظهار رسالة نجاح
                showAlert('success', 'تم حفظ التغييرات بنجاح!');
            }, 1000);
        }

        // عرض تنبيه
        function showAlert(type, message) {
            // إزالة أي تنبيهات سابقة
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertElement = document.createElement('div');
            alertElement.className = `alert alert-${type}`;
            alertElement.textContent = message;
            alertElement.style.display = 'block';
            alertElement.style.position = 'fixed';
            alertElement.style.top = '20px';
            alertElement.style.left = '50%';
            alertElement.style.transform = 'translateX(-50%)';
            alertElement.style.zIndex = '9999';
            alertElement.style.padding = '15px 30px';
            alertElement.style.borderRadius = '8px';
            alertElement.style.fontWeight = 'bold';
            alertElement.style.minWidth = '300px';
            alertElement.style.textAlign = 'center';
            alertElement.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            
            // إضافة زر إغلاق
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
                position: absolute;
                top: 5px;
                right: 10px;
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: inherit;
            `;
            closeBtn.onclick = () => alertElement.remove();
            alertElement.appendChild(closeBtn);
            
            // إضافة التنبيه إلى بداية body
            document.body.prepend(alertElement);
            
            // إخفاء التنبيه بعد 8 ثواني
            setTimeout(() => {
                if (alertElement.parentNode) {
                alertElement.style.display = 'none';
                alertElement.remove();
                }
            }, 8000);
        }

        // تهيئة البيانات الأولية
        function initializeData() {
            // تحميل المستخدمين من localStorage
            users = JSON.parse(localStorage.getItem('users') || '[]');
            // تحميل باقي البيانات
            appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            consultations = JSON.parse(localStorage.getItem('consultations') || '[]');
            tests = JSON.parse(localStorage.getItem('tests') || '[]');
            doctors = JSON.parse(localStorage.getItem('doctors') || '[]');
            inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            expiredInventory = JSON.parse(localStorage.getItem('expiredInventory') || '[]');
            systemSettings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
        }

        // حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('appointments', JSON.stringify(appointments));
            localStorage.setItem('consultations', JSON.stringify(consultations));
            localStorage.setItem('tests', JSON.stringify(tests));
            localStorage.setItem('doctors', JSON.stringify(doctors));
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('expiredInventory', JSON.stringify(expiredInventory));
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
        }
    </script>
</body>
</html>